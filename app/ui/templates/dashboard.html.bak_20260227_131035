<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartX Vision Platform v3 â€” EPI Check</title>
<link rel="icon" type="image/x-icon" href="/static/img/favicon.ico">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Open+Sans:wght@400;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<!-- Adicione no <head> do seu HTML -->
<meta http-equiv="Permissions-Policy" content="camera=*, microphone=()">
<meta http-equiv="Feature-Policy" content="camera *; microphone 'none'">
<style>
:root {
  --bg: #f0f4f8;
  --surface: #ffffff;
  --surface2: #f7f9fc;
  --surface3: #edf2f7;
  --border: rgba(26,115,232,0.12);
  --border-bright: rgba(26,115,232,0.35);
  --primary: #1a73e8;
  --primary-dim: rgba(26,115,232,0.08);
  --accent: #e67700;
  --accent-dim: rgba(230,119,0,0.1);
  --success: #1e8c45;
  --success-dim: rgba(30,140,69,0.08);
  --danger: #d93025;
  --danger-dim: rgba(217,48,37,0.08);
  --warning: #b06000;
  --text: #1a202c;
  --text-muted: #4a5568;
  --text-dim: #a0aec0;
  --glow: 0 2px 12px rgba(26,115,232,0.1);
  --glow-strong: 0 4px 24px rgba(26,115,232,0.18);
}

* { font-family: "Poppins", "Open Sans", "Google Sans", "Roboto", sans-serif !important; margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: "Poppins", "Open Sans", "Google Sans", "Roboto", sans-serif !important;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    radial-gradient(ellipse 80% 50% at 20% 10%, rgba(26,115,232,0.04) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 80%, rgba(230,119,0,0.03) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

/* HEADER */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  height: 70px;
  box-shadow: 0 1px 8px rgba(26,115,232,0.08);
}

.logo-mark {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
}

.logo-img {
  height: 40px;
  width: auto;
  object-fit: contain;
}

.logo-version {
  font-size: 10px;
  color: var(--text-muted);
  background: var(--surface2);
  padding: 2px 6px;
  border-radius: 4px;
  border: 1px solid var(--border);
  font-family: 'Space Mono', monospace;
}

.header-divider {
  width: 1px;
  height: 20px;
  background: var(--border);
}

.status-dot {
  width: 7px;
  height: 7px;
  background: var(--success);
  border-radius: 50%;
  box-shadow: 0 0 8px var(--success);
  animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.status-text {
  font-size: 12px;
  color: var(--success);
  font-family: 'Space Mono', monospace;
}

.company-selector {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 8px;
}

.company-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-family: 'Space Mono', monospace;
}

.company-sel {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 13px;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  transition: border-color 0.2s;
}

.company-sel:hover { border-color: var(--border-bright); }

/* TABS */
.tabs-wrapper {
  position: sticky;
  top: 10px;
  z-index: 99;
  background: rgba(255,255,255,0.97);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  overflow-x: auto;
  display: flex;
  scrollbar-width: none;
  box-shadow: 0 1px 4px rgba(26,115,232,0.05);
}

.tabs-wrapper::-webkit-scrollbar { display: none; }

.tab {
  padding: 14px 16px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-muted);
  border-bottom: 2px solid transparent;
  white-space: nowrap;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  font-family: 'Space Mono', monospace;
  position: relative;
}

.tab:hover { color: var(--primary); background: var(--primary-dim); }

.tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

.tab-icon { font-size: 14px; }

/* PANELS */
.panels {
  padding: 24px;
  position: relative;
  z-index: 1;
  max-width: 1280px;
  margin: 0 auto;
}

.panel { display: none; animation: fadeIn 0.3s ease; }
.panel.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* CARDS */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  transition: border-color 0.2s, box-shadow 0.2s;
  box-shadow: 0 1px 4px rgba(26,115,232,0.05);
}

.card:hover { border-color: var(--border-bright); box-shadow: var(--glow-strong); }

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
}

.card-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  background: var(--primary-dim);
  border: 1px solid var(--border);
}

.card-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-family: 'Space Mono', monospace;
}

/* GRID */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; }

@media(max-width: 900px) {
  .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
}

/* STAT CARDS */
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
  box-shadow: 0 1px 4px rgba(26,115,232,0.05);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), transparent);
  opacity: 0;
  transition: opacity 0.2s;
}

.stat-card:hover::before { opacity: 1; }
.stat-card:hover { border-color: var(--border-bright); box-shadow: var(--glow-strong); }

.stat-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-family: 'Space Mono', monospace;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
  font-family: 'Space Mono', monospace;
  line-height: 1;
}

.stat-sub {
  font-size: 12px;
  color: var(--text-muted);
}

/* FORM ELEMENTS */
label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-family: 'Space Mono', monospace;
}

input, select, textarea {
  width: 100%;
  padding: 10px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 14px;
  font-family: 'DM Sans', sans-serif;
  margin-bottom: 14px;
  transition: border-color 0.2s, box-shadow 0.2s;
  outline: none;
}

input:focus, select:focus, textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
  background: #fff;
}

input[type=file] {
  padding: 8px;
  cursor: pointer;
  color: var(--text-muted);
}

input[type=range] {
  -webkit-appearance: none;
  height: 4px;
  background: var(--surface3);
  border: none;
  border-radius: 2px;
  padding: 0;
  margin-bottom: 6px;
  cursor: pointer;
}

input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: var(--primary);
  border-radius: 50%;
  box-shadow: 0 1px 4px rgba(26,115,232,0.4);
  cursor: pointer;
}

input[type=checkbox] {
  width: 16px;
  height: 16px;
  margin-right: 8px;
  accent-color: var(--primary);
}

.range-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
}

.range-row input[type=range] { flex: 1; margin-bottom: 0; }

.range-val {
  font-family: 'Space Mono', monospace;
  font-size: 12px;
  color: var(--primary);
  min-width: 36px;
  text-align: right;
}

.checkbox-row {
  display: flex;
  align-items: center;
  margin-bottom: 14px;
  gap: 4px;
}

.checkbox-row label {
  margin: 0;
  text-transform: none;
  letter-spacing: 0;
  font-size: 13px;
  color: var(--text);
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-weight: 400;
}

/* BUTTONS */
.btn {
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-family: 'DM Sans', sans-serif;
  letter-spacing: 0.02em;
  position: relative;
  overflow: hidden;
}

.btn:active { transform: scale(0.97); }

.btn-primary {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 2px 8px rgba(26,115,232,0.3);
}
.btn-primary:hover { background: #1557b0; box-shadow: 0 4px 12px rgba(26,115,232,0.4); }

.btn-success {
  background: var(--success);
  color: #fff;
  box-shadow: 0 2px 8px rgba(30,140,69,0.3);
}
.btn-success:hover { background: #166c37; }

.btn-danger {
  background: var(--danger);
  color: #fff;
  box-shadow: 0 2px 8px rgba(217,48,37,0.3);
}
.btn-danger:hover { background: #b71c1c; }

.btn-warning {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 2px 8px rgba(230,119,0,0.3);
}
.btn-warning:hover { background: #c45900; }

.btn-ghost {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
}
.btn-ghost:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-dim); }

.btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 6px; }

.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

/* BADGES */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  letter-spacing: 0.04em;
}

.badge-ok {
  background: rgba(30,140,69,0.1);
  color: var(--success);
  border: 1px solid rgba(30,140,69,0.25);
}

.badge-warn {
  background: rgba(176,96,0,0.08);
  color: var(--warning);
  border: 1px solid rgba(176,96,0,0.2);
}

.badge-err {
  background: var(--danger-dim);
  color: var(--danger);
  border: 1px solid rgba(217,48,37,0.2);
}

.badge-off {
  background: var(--surface3);
  color: var(--text-muted);
  border: 1px solid var(--border);
}

.badge-blue {
  background: var(--primary-dim);
  color: var(--primary);
  border: 1px solid rgba(26,115,232,0.2);
}

/* TABLES */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th {
  padding: 10px 14px;
  text-align: left;
  background: var(--surface2);
  color: var(--text-muted);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-family: 'Space Mono', monospace;
  border-bottom: 1px solid var(--border);
}

th:first-child { border-radius: 8px 0 0 0; }
th:last-child { border-radius: 0 8px 0 0; }

td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  color: var(--text);
}

tr:last-child td { border-bottom: none; }
tr:hover td { background: var(--surface2); }

/* TOAST */
.toast {
  position: fixed;
  top: 72px;
  right: 20px;
  padding: 14px 20px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 500;
  z-index: 9999;
  display: none;
  animation: toastIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
  border: 1px solid;
  min-width: 240px;
  font-family: 'DM Sans', sans-serif;
  box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}

@keyframes toastIn {
  from { transform: translateX(100%) scale(0.8); opacity: 0; }
  to { transform: translateX(0) scale(1); opacity: 1; }
}

.toast.success {
  background: #f0fdf4;
  border-color: rgba(30,140,69,0.3);
  color: var(--success);
}

.toast.error {
  background: #fef2f2;
  border-color: rgba(217,48,37,0.3);
  color: var(--danger);
}

/* PROGRESS BAR */
.progress-bar {
  width: 100%;
  height: 6px;
  background: var(--surface3);
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), #4299e1);
  border-radius: 3px;
  transition: width 0.5s;
  box-shadow: 0 0 6px rgba(26,115,232,0.4);
}

/* DETECTION RESULT */
.result-box {
  padding: 16px;
  border-radius: 10px;
  margin: 12px 0;
  border: 1px solid;
}

.result-compliant {
  background: #f0fdf4;
  border-color: rgba(30,140,69,0.25);
}

.result-noncompliant {
  background: #fef2f2;
  border-color: rgba(217,48,37,0.25);
}

.result-title {
  font-size: 16px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  margin-bottom: 8px;
}

.result-title.ok { color: var(--success); }
.result-title.fail { color: var(--danger); }

/* STREAM */
.stream-container {
  background: var(--surface2);
  border-radius: 10px;
  overflow: hidden;
  position: relative;
  min-height: 320px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--border);
}

.stream-container img { width: 100%; height: auto; }

.stream-placeholder {
  color: var(--text-dim);
  font-size: 13px;
  font-family: 'Space Mono', monospace;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.stream-placeholder::before {
  content: 'â—‰';
  font-size: 32px;
  color: var(--text-dim);
}

/* ANNOTATION CANVAS */
#ann-canvas-wrap {
  position: relative;
  display: inline-block;
  cursor: crosshair;
  border-radius: 8px;
  overflow: hidden;
}

#ann-canvas-wrap canvas { position: absolute; top: 0; left: 0; }

/* PREVIEW IMAGE */
.preview-img {
  max-width: 100%;
  border-radius: 10px;
  border: 1px solid var(--border);
}

/* PPE CONFIG CHECKBOXES */
.ppe-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
}

.ppe-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.ppe-item:hover { border-color: var(--border-bright); }
.ppe-item input { width: auto; margin: 0; }
.ppe-item label { margin: 0; text-transform: none; letter-spacing: 0; font-size: 13px; color: var(--text); cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 400; }

/* ANN LOG */
.ann-log {
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  background: var(--surface2);
  color: var(--text-muted);
  padding: 10px 14px;
  border-radius: 8px;
  margin-top: 10px;
  max-height: 120px;
  overflow-y: auto;
  border: 1px solid var(--border);
  line-height: 1.8;
}

/* SECTION HEADER */
.section-header {
  margin-bottom: 20px;
}

.section-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  font-family: 'Space Mono', monospace;
  margin-bottom: 4px;
}

.section-sub {
  font-size: 13px;
  color: var(--text-muted);
}

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--surface2); }
::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--primary); }

/* INFO ROW */
.info-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}

.info-row:last-child { border-bottom: none; }
.info-key { color: var(--text-muted); font-family: 'Space Mono', monospace; font-size: 11px; }
.info-val { color: var(--text); font-weight: 500; }

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
  font-size: 13px;
  font-family: 'Space Mono', monospace;
}

.empty-state::before {
  content: attr(data-icon);
  display: block;
  font-size: 32px;
  margin-bottom: 12px;
  opacity: 0.4;
}

/* LOADING SHIMMER */
.shimmer {
  background: linear-gradient(90deg, var(--surface2) 0%, var(--surface3) 50%, var(--surface2) 100%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 6px;
  height: 14px;
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

/* ===================== TRAIN SPINNER + DOWNLOAD ===================== */
.train-spinner {
  display: inline-block;
  width: 13px;
  height: 13px;
  border: 2px solid rgba(255,255,255,0.35);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  vertical-align: middle;
  flex-shrink: 0;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.progress-fill.training-pulse {
  background: linear-gradient(90deg, var(--primary), #63b3ed, var(--primary));
  background-size: 200% 100%;
  animation: progress-pulse 2s linear infinite;
}

@keyframes progress-pulse {
  0%   { background-position: 0% 0; }
  100% { background-position: 200% 0; }
}

.train-download-box {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: rgba(30,140,69,0.06);
  border: 1px solid rgba(30,140,69,0.2);
  border-radius: 10px;
  margin-top: 10px;
}

.train-download-box .dl-icon { font-size: 22px; flex-shrink: 0; }
.train-download-box .dl-info { flex: 1; min-width: 0; }
.train-download-box .dl-label { font-size: 12px; font-weight: 600; color: var(--success); font-family: 'Space Mono', monospace; margin-bottom: 2px; }
.train-download-box .dl-path { font-size: 11px; color: var(--text-muted); font-family: 'Space Mono', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.train-status-area {
  margin-top: 14px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.train-epoch-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 6px;
}

.train-epoch-label { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text-muted); }
.train-epoch-pct { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--primary); font-weight: 700; }
.train-meta { font-size: 11px; color: var(--text-dim); font-family: 'Space Mono', monospace; margin-top: 4px; }
/* ================================================================== */

/* ==================== FILE BROWSER CSS ==================== */
.fb-list { display:flex; flex-direction:column; gap:2px; }

.fb-row {
  display:grid;
  grid-template-columns: 32px 1fr 90px 140px 120px;
  align-items:center;
  gap:10px;
  padding:8px 10px;
  border-radius:7px;
  cursor:pointer;
  transition:background 0.15s;
  font-size:13px;
  border:1px solid transparent;
}
.fb-row:hover { background:var(--surface2); border-color:var(--border); }
.fb-row.fb-dir  { font-weight:600; color:var(--primary); }
.fb-row .fb-icon { font-size:18px; text-align:center; }
.fb-row .fb-name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.fb-row .fb-size { color:var(--text-muted); font-family:Space Mono,monospace; font-size:11px; text-align:right; }
.fb-row .fb-date { color:var(--text-dim); font-family:Space Mono,monospace; font-size:11px; }
.fb-row .fb-actions { display:flex; gap:6px; justify-content:flex-end; opacity:0; transition:opacity 0.15s; }
.fb-row:hover .fb-actions { opacity:1; }

.fb-thead {
  display:grid;
  grid-template-columns: 32px 1fr 90px 140px 120px;
  gap:10px;
  padding:6px 10px;
  font-family:Space Mono,monospace;
  font-size:10px;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:0.08em;
  border-bottom:1px solid var(--border);
  margin-bottom:4px;
}

.fb-grid {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap:12px;
}

.fb-card {
  border:1px solid var(--border);
  border-radius:10px;
  overflow:hidden;
  cursor:pointer;
  transition:all 0.2s;
  background:var(--surface);
  position:relative;
}
.fb-card:hover { border-color:var(--border-bright); box-shadow:var(--glow-strong); transform:translateY(-2px); }

.fb-card-thumb {
  width:100%;
  aspect-ratio:1;
  object-fit:cover;
  background:var(--surface2);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:32px;
}
.fb-card-thumb img { width:100%; height:100%; object-fit:cover; }

.fb-card-info { padding:7px 8px; border-top:1px solid var(--border); }
.fb-card-name { font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--text); font-family:Space Mono,monospace; }
.fb-card-size { font-size:10px; color:var(--text-dim); font-family:Space Mono,monospace; margin-top:2px; }

.fb-card-actions { position:absolute; top:4px; right:4px; display:flex; gap:3px; opacity:0; transition:opacity 0.15s; }
.fb-card:hover .fb-card-actions { opacity:1; }

.fb-action-btn {
  width:24px; height:24px; border:none; border-radius:6px; cursor:pointer; font-size:12px;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.55); color:#fff; transition:background 0.15s;
}
.fb-action-btn:hover { background:rgba(0,0,0,0.8); }
.fb-action-btn.del { background:rgba(217,48,37,0.7); }
.fb-action-btn.del:hover { background:var(--danger); }

.fb-crumb { font-family:Space Mono,monospace; font-size:11px; color:var(--text-muted); cursor:pointer; padding:3px 6px; border-radius:4px; white-space:nowrap; transition:all 0.15s; }
.fb-crumb:hover { color:var(--primary); background:var(--primary-dim); }
.fb-crumb.active { color:var(--text); cursor:default; font-weight:700; }
.fb-crumb.active:hover { background:transparent; color:var(--text); }
.fb-sep { color:var(--text-dim); font-size:10px; }

.fb-empty { text-align:center; padding:40px 20px; color:var(--text-muted); font-size:13px; font-family:Space Mono,monospace; }
/* ========================================================== */

/* ==================== FILE BROWSER MODALS ==================== */
.fb-modal-backdrop {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.45); z-index:10001;
  align-items:center; justify-content:center;
}
.fb-modal-backdrop.open { display:flex; }
.fb-modal {
  background:var(--surface); border:1px solid var(--border-bright);
  border-radius:14px; padding:28px 28px 24px;
  width:480px; max-width:95vw;
  box-shadow:0 16px 48px rgba(0,0,0,0.2);
  position:relative;
  animation:fbModalIn 0.22s cubic-bezier(0.34,1.4,0.64,1);
}
@keyframes fbModalIn {
  from { transform:scale(0.88) translateY(12px); opacity:0 }
  to   { transform:scale(1)    translateY(0);    opacity:1 }
}
.fb-modal-title { font-family:'Space Mono',monospace; font-size:13px; font-weight:700; color:var(--text); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:18px; display:flex; align-items:center; gap:8px; }
.fb-modal-close { position:absolute; top:14px; right:16px; background:none; border:none; cursor:pointer; font-size:18px; color:var(--text-muted); line-height:1; padding:4px 6px; border-radius:6px; transition:background 0.15s,color 0.15s; }
.fb-modal-close:hover { background:var(--danger-dim); color:var(--danger); }
.fb-dropzone { border:2px dashed var(--border-bright); border-radius:10px; padding:32px 20px; text-align:center; cursor:pointer; transition:all 0.2s; background:var(--surface2); margin-bottom:14px; }
.fb-dropzone:hover, .fb-dropzone.drag-over { border-color:var(--primary); background:var(--primary-dim); }
.fb-dropzone-icon  { font-size:32px; margin-bottom:8px; }
.fb-dropzone-text  { font-size:13px; color:var(--text-muted); }
.fb-dropzone-sub   { font-size:11px; color:var(--text-dim); font-family:'Space Mono',monospace; margin-top:4px; }
.fb-queue { max-height:150px; overflow-y:auto; margin-bottom:14px; display:flex; flex-direction:column; gap:4px; }
.fb-queue-item { display:flex; align-items:center; gap:8px; padding:7px 10px; background:var(--surface2); border:1px solid var(--border); border-radius:7px; font-size:12px; }
.fb-queue-item .fq-icon { font-size:14px; }
.fb-queue-item .fq-name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:var(--text); }
.fb-queue-item .fq-size { color:var(--text-dim); font-family:'Space Mono',monospace; font-size:10px; }
.fb-queue-item .fq-rm   { background:none; border:none; cursor:pointer; color:var(--text-dim); font-size:14px; padding:0 2px; transition:color 0.15s; }
.fb-queue-item .fq-rm:hover { color:var(--danger); }
.fb-upload-progress { margin-bottom:12px; display:none; }
.fb-upload-progress-label { display:flex; justify-content:space-between; font-family:'Space Mono',monospace; font-size:11px; color:var(--text-muted); margin-bottom:6px; }
/* ============================================================= */

/* ==================== INLINE VIDEO PLAYER ==================== */
.vp-player-wrap {
  position: relative;
  background: #0a0a0f;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid var(--border);
  user-select: none;
}

.vp-player-wrap video {
  width: 100%;
  height: auto;
  display: block;
}

.vp-player-wrap canvas#vp-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.vp-controls {
  background: rgba(10,10,15,0.92);
  backdrop-filter: blur(8px);
  padding: 10px 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  border-top: 1px solid rgba(255,255,255,0.06);
}

.vp-seek {
  flex: 1;
  min-width: 120px;
  -webkit-appearance: none;
  height: 4px;
  background: rgba(255,255,255,0.15);
  border: none;
  border-radius: 2px;
  cursor: pointer;
  outline: none;
  margin: 0;
  padding: 0;
}
.vp-seek::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px; height: 12px;
  background: var(--primary);
  border-radius: 50%;
  cursor: pointer;
}

.vp-btn {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 6px;
  color: #e2e8f0;
  font-size: 13px;
  padding: 4px 10px;
  cursor: pointer;
  transition: background 0.15s;
  white-space: nowrap;
  font-family: 'Space Mono', monospace;
}
.vp-btn:hover { background: rgba(255,255,255,0.16); }
.vp-btn.active { background: var(--primary); border-color: var(--primary); color: #fff; }

.vp-time {
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  color: #718096;
  white-space: nowrap;
}

.vp-status-badge {
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  padding: 3px 10px;
  border-radius: 20px;
  white-space: nowrap;
}
.vp-status-badge.ok   { background: rgba(30,140,69,0.25);  color: #68d391; border: 1px solid rgba(104,211,145,0.3); }
.vp-status-badge.fail { background: rgba(217,48,37,0.25);  color: #fc8181; border: 1px solid rgba(252,129,129,0.3); }
.vp-status-badge.idle { background: rgba(255,255,255,0.06); color: #718096; border: 1px solid rgba(255,255,255,0.1); }

.vp-speed-sel {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 6px;
  color: #e2e8f0;
  font-size: 11px;
  padding: 4px 6px;
  cursor: pointer;
  font-family: 'Space Mono', monospace;
}
.vp-speed-sel option { background: #1a202c; }
/* ============================================================ */

/* ==================== VIDEO FRAME PREVIEW MODAL ==================== */
.vp-modal-backdrop {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  z-index: 10002;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 16px;
}
.vp-modal-backdrop.open { display: flex; }

.vp-modal {
  background: var(--surface);
  border: 1px solid var(--border-bright);
  border-radius: 14px;
  padding: 24px;
  width: 820px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 16px 48px rgba(0,0,0,0.35);
  position: relative;
  animation: vpIn 0.2s cubic-bezier(0.34,1.4,0.64,1);
}
@keyframes vpIn {
  from { transform: scale(0.9) translateY(16px); opacity: 0; }
  to   { transform: scale(1) translateY(0); opacity: 1; }
}
.vp-modal-close {
  position: absolute; top: 14px; right: 16px;
  background: none; border: none; cursor: pointer;
  font-size: 20px; color: var(--text-muted); padding: 4px 7px;
  border-radius: 6px; transition: background 0.15s, color 0.15s; line-height: 1;
}
.vp-modal-close:hover { background: var(--danger-dim); color: var(--danger); }

.vp-modal-title {
  font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700;
  color: var(--text); text-transform: uppercase; letter-spacing: 0.08em;
  margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
}
.vp-img-wrap {
  position: relative; border-radius: 10px; overflow: hidden;
  background: #0a0a0f; min-height: 200px;
  display: flex; align-items: center; justify-content: center;
}
.vp-img-wrap img { width: 100%; height: auto; display: block; border-radius: 10px; }
.vp-loading {
  color: #4a5568; font-family: 'Space Mono', monospace; font-size: 13px;
  text-align: center; padding: 40px;
}
.vp-result-row {
  display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; align-items: center;
}
/* ===================================================================== */

/* ==================== BROWSER CAMERA CSS ==================== */
.cam-container {
  position: relative;
  background: #0a0a0f;
  border-radius: 12px;
  overflow: hidden;
  min-height: 300px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--border);
}

.cam-container video,
.cam-container canvas,
.cam-container img.cam-result {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 0;
}

.cam-overlay {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.cam-status-bar {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  pointer-events: none;
}

.cam-fps-badge {
  background: rgba(0,0,0,0.65);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 6px;
  padding: 3px 8px;
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  color: #a0aec0;
  backdrop-filter: blur(4px);
}

.cam-fps-badge.compliant    { color: #68d391; border-color: rgba(104,211,145,0.3); }
.cam-fps-badge.noncompliant { color: #fc8181; border-color: rgba(252,129,129,0.3); }

.cam-placeholder {
  color: #4a5568;
  font-size: 13px;
  font-family: 'Space Mono', monospace;
  text-align: center;
  padding: 40px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.cam-placeholder::before {
  content: 'ðŸ“·';
  font-size: 36px;
  opacity: 0.35;
}

.cam-selector {
  position: absolute;
  top: 10px;
  right: 10px;
  pointer-events: all;
  background: rgba(0,0,0,0.6);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 6px;
  padding: 4px 8px;
  color: #e2e8f0;
  font-size: 12px;
  font-family: 'Space Mono', monospace;
  backdrop-filter: blur(4px);
  cursor: pointer;
  max-width: 180px;
  display: none;
}

.cam-selector.visible { display: block; }

.cam-mirror-btn {
  position: absolute;
  bottom: 10px;
  right: 10px;
  pointer-events: all;
  background: rgba(0,0,0,0.6);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 6px;
  padding: 5px 9px;
  color: #a0aec0;
  font-size: 12px;
  cursor: pointer;
  display: none;
  backdrop-filter: blur(4px);
  transition: color 0.2s;
}
.cam-mirror-btn:hover { color: #fff; }
.cam-mirror-btn.visible { display: block; }

.cam-scanline {
  position: absolute;
  left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, rgba(26,115,232,0.6), transparent);
  animation: cam-scan 3s linear infinite;
  pointer-events: none;
  display: none;
}
.cam-scanning .cam-scanline { display: block; }

@keyframes cam-scan {
  0%   { top: 0%; }
  100% { top: 100%; }
}
/* ============================================================ */
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="logo-mark">
    <img class="logo-img" src="/static/img/logoSmartx.png" alt="SmartX">
    <span class="logo-version">v3.0</span>
  </div>
  <div class="header-divider"></div>
  <div class="status-dot"></div>
  <span class="status-text">ONLINE</span>
  <div class="company-selector">
    <span class="company-label">Company</span>
    <select class="company-sel" id="companySelect" onchange="switchCompany()">
      <option value="1">Company 1</option>
      <option value="2">Company 2</option>
      <option value="3">Company 3</option>
    </select>
  </div>
</header>

<!-- TABS -->
<nav class="tabs-wrapper">
  <div class="tab active" onclick="showPanel('dashboard', this)"><span class="tab-icon">â¬¡</span> Dashboard</div>
  <div class="tab" onclick="showPanel('faces', this)"><span class="tab-icon">â—‰</span> Faces</div>
  <div class="tab" onclick="showPanel('config', this)"><span class="tab-icon">â—ˆ</span> PPE Config</div>
  <div class="tab" onclick="showPanel('upload', this)"><span class="tab-icon">â†‘</span> Upload</div>
  <div class="tab" onclick="showPanel('convert', this)"><span class="tab-icon">â‡Œ</span> Converter</div>
  <div class="tab" onclick="showPanel('annotate', this)"><span class="tab-icon">â—»</span> Annotate</div>
  <div class="tab" onclick="showPanel('train', this)"><span class="tab-icon">âš™</span> Train</div>
  <div class="tab" onclick="showPanel('detect', this)"><span class="tab-icon">â—Ž</span> Detect Image</div>
  <div class="tab" onclick="showPanel('video', this)"><span class="tab-icon">â–¶</span> Detect Video</div>
  <div class="tab" onclick="showPanel('files', this)"><span class="tab-icon">ðŸ—‚</span> Files</div>
  <div class="tab" onclick="showPanel('stream', this)"><span class="tab-icon">â—ˆ</span> Live Stream</div>
</nav>

<div class="toast" id="toast"></div>

<div class="panels">

<!-- ===== DASHBOARD ===== -->
<div class="panel active" id="panel-dashboard">
  <div class="section-header">
    <div class="section-title">System Overview</div>
    <div class="section-sub">Real-time platform status and metrics</div>
  </div>
  <div class="grid-4" style="margin-bottom:16px">
    <div class="stat-card">
      <div class="stat-label">Active Classes</div>
      <div class="stat-value" id="stat-classes">â€”</div>
      <div class="stat-sub">PPE categories</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Models</div>
      <div class="stat-value" id="stat-models">â€”</div>
      <div class="stat-sub">trained models</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">People</div>
      <div class="stat-value" id="stat-people">â€”</div>
      <div class="stat-sub">face profiles</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Storage</div>
      <div class="stat-value" id="stat-storage">â€”</div>
      <div class="stat-sub">MB used</div>
    </div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="card-header"><div class="card-icon">â—ˆ</div><div class="card-title">PPE Classes Status</div></div>
      <div id="dash-classes"><div class="shimmer" style="width:80%"></div></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-icon">âš™</div><div class="card-title">Training Status</div></div>
      <div id="dash-train"><div class="shimmer" style="width:60%"></div></div>
    </div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="card-header"><div class="card-icon">â†‘</div><div class="card-title">Photos by Category</div></div>
      <div id="dash-photos"><div class="shimmer"></div></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-icon">â—»</div><div class="card-title">Annotation Stats</div></div>
      <div id="dash-annotations"><div class="shimmer"></div></div>
    </div>
  </div>
</div>

<!-- ===== FACE REGISTER ===== -->
<div class="panel" id="panel-faces">
  <div class="section-header">
    <div class="section-title">Face Registry</div>
    <div class="section-sub">Register people for recognition during detection</div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="card-header"><div class="card-icon">â—‰</div><div class="card-title">Register Person</div></div>
      <label>Person Code</label>
      <input type="text" id="face-code" placeholder="john_silva">
      <label>Full Name</label>
      <input type="text" id="face-name" placeholder="John Silva">
      <label>Badge ID</label>
      <input type="text" id="face-badge" placeholder="EMP001">
      <label>Face Photo</label>
      <input type="file" id="face-file" accept="image/*">
      <button class="btn btn-success" onclick="registerFace()">â—‰ Register Face</button>
      <div id="face-result" style="margin-top:12px"></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-icon">â¬¡</div><div class="card-title">Registered People</div></div>
      <div class="btn-group" style="margin-bottom:16px">
        <button class="btn btn-sm btn-ghost" onclick="loadPeople()">â†» Refresh</button>
        <button class="btn btn-sm btn-warning" onclick="rebuildFaceDB()">âš™ Rebuild DB</button>
      </div>
      <div id="people-list" class="empty-state" data-icon="â—‰">No people registered</div>
    </div>
  </div>
</div>

<!-- ===== PPE CONFIG ===== -->
<div class="panel" id="panel-config">
  <div class="section-header">
    <div class="section-title">PPE Configuration</div>
    <div class="section-sub">Enable only the PPE types you have training images for</div>
  </div>
  <div class="card">
    <div class="ppe-grid" id="config-checkboxes"></div>
    <br>
    <button class="btn btn-primary" onclick="savePPEConfig()">Save Configuration</button>
  </div>
</div>

<!-- ===== UPLOAD ===== -->
<div class="panel" id="panel-upload">
  <div class="section-header">
    <div class="section-title">Upload Training Data</div>
    <div class="section-sub">Add images to train your detection models</div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="card-header"><div class="card-icon">â†‘</div><div class="card-title">Training Photos</div></div>
      <label>Category</label>
      <select id="upload-category">
        <option value="helmet">helmet</option>
        <option value="boots">boots</option>
        <option value="person">person</option>
        <option value="gloves">gloves</option>
        <option value="thermal_coat">thermal_coat</option>
        <option value="thermal_pants">thermal_pants</option>
        <option value="full_body">full_body</option>
      </select>
      <label>Images</label>
      <input type="file" id="upload-files" multiple accept="image/*">
      <button class="btn btn-primary" onclick="uploadPhotos()">â†‘ Upload Photos</button>
      <div id="upload-result" style="margin-top:12px"></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-icon">â¬¡</div><div class="card-title">Bulk Upload â€” Images + Labels</div></div>
      <label>Category</label>
      <select id="bulk-category">
        <option value="mixed">mixed</option>
        <option value="helmet">helmet</option>
        <option value="boots">boots</option>
        <option value="person">person</option>
      </select>
      <label>Class ID Remap JSON (optional)</label>
      <input type="text" id="bulk-remap" value="{}" placeholder='{"0":3,"1":4}'>
      <label>Files (images + .txt)</label>
      <input type="file" id="bulk-files" multiple accept="image/*,.txt">
      <button class="btn btn-primary" onclick="bulkUpload()">â†‘ Bulk Upload</button>
      <div id="bulk-result" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<!-- ===== CONVERTER ===== -->
<div class="panel" id="panel-convert">
  <div class="section-header">
    <div class="section-title">Annotation Converter</div>
    <div class="section-sub">Convert Polygon/OBB â†’ YOLO BBox format</div>
  </div>
  <div class="card">
    <label>Class ID Remap JSON</label>
    <input type="text" id="conv-remap" value='{"0":3}' placeholder='{"0":3,"1":4}'>
    <p style="font-size:12px;color:var(--text-muted);margin-top:-10px;margin-bottom:14px;font-family:'Space Mono',monospace;">IDs: 0=thermal_coat Â· 1=thermal_pants Â· 2=gloves Â· 3=helmet Â· 4=boots Â· 5=person</p>
    <label>Upload Roboflow Files (images + .txt)</label>
    <input type="file" id="conv-files" multiple accept="image/*,.txt">
    <button class="btn btn-warning" onclick="convertUpload()">â‡Œ Convert & Import</button>
    <div id="conv-result" style="margin-top:12px"></div>
  </div>
</div>

<!-- ===== ANNOTATE ===== -->
<div class="panel" id="panel-annotate">
  <div class="section-header">
    <div class="section-title">Visual Annotation</div>
    <div class="section-sub">Draw bounding boxes directly on images</div>
  </div>
  <div class="card">
    <div class="grid-3" style="margin-bottom:14px">
      <div>
        <label>Class</label>
        <select id="ann-class"></select>
      </div>
      <div>
        <label>Image</label>
        <select id="ann-image-sel" onchange="loadAnnotationImage()"></select>
      </div>
      <div style="padding-top:22px">
        <div class="btn-group">
          <button class="btn btn-sm btn-ghost" onclick="annUndo()">â†© Undo</button>
          <button class="btn btn-sm btn-danger" onclick="annClear()">âœ• Clear</button>
          <button class="btn btn-sm btn-success" onclick="annSave()">âœ“ Save</button>
          <button class="btn btn-sm btn-ghost" onclick="loadAnnotationImages()">â†»</button>
        </div>
      </div>
    </div>
    <div id="ann-canvas-wrap">
      <p id="ann-placeholder" style="color:var(--text-muted);padding:48px;font-family:'Space Mono',monospace;font-size:13px;">â—» Select an image to annotate</p>
    </div>
    <div class="ann-log" id="ann-log"></div>
  </div>
</div>

<!-- ===== TRAIN ===== -->
<div class="panel" id="panel-train">
  <div class="section-header">
    <div class="section-title">Model Training</div>
    <div class="section-sub">Generate datasets and train YOLOv8 models</div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="card-header"><div class="card-icon">â¬¡</div><div class="card-title">1 â€” Generate Dataset</div></div>
      <label>Train / Valid Split</label>
      <div class="range-row">
        <input type="range" id="train-split" min="0.5" max="0.95" step="0.05" value="0.8"
          oninput="document.getElementById('split-val').textContent=this.value">
        <span class="range-val" id="split-val">0.8</span>
      </div>
      <br>
      <button class="btn btn-primary" onclick="generateDataset()">â¬¡ Generate Dataset</button>
      <div id="dataset-result" style="margin-top:14px"></div>
    </div>

    <div class="card">
      <div class="card-header"><div class="card-icon">âš™</div><div class="card-title">2 â€” Train Model</div></div>
      <label>Base Model</label>
      <select id="train-model">
        <option value="yolov8n.pt">yolov8n â€” Fast</option>
        <option value="yolov8s.pt">yolov8s â€” Small</option>
        <option value="yolov8m.pt" selected>yolov8m â€” Medium</option>
        <option value="yolov8l.pt">yolov8l â€” Large</option>
      </select>
      <div class="grid-2">
        <div>
          <label>Epochs</label>
          <input type="number" id="train-epochs" value="60" min="10" max="300">
        </div>
        <div>
          <label>Batch Size</label>
          <input type="number" id="train-batch" value="16" min="4" max="64">
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Image Size</label>
          <input type="number" id="train-imgsz" value="640">
        </div>
        <div>
          <label>Patience</label>
          <input type="number" id="train-patience" value="15">
        </div>
      </div>
      <button class="btn btn-success" id="btn-start-train" onclick="startTraining()">
        <span id="btn-train-icon">âš™</span>
        <span id="btn-train-text">Start Training</span>
      </button>
      <div class="train-status-area" id="train-status-area" style="display:none"></div>
      <div id="train-download" style="display:none"></div>
    </div>
  </div>
</div>

<!-- ===== DETECT IMAGE ===== -->
<div class="panel" id="panel-detect">
  <div class="section-header">
    <div class="section-title">Image Detection</div>
    <div class="section-sub">Analyze single images for PPE compliance</div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="card-header"><div class="card-icon">â—Ž</div><div class="card-title">Detection Settings</div></div>
      <label>Image</label>
      <input type="file" id="detect-file" accept="image/*" onchange="previewDetect(this)">
      <label>Confidence Threshold</label>
      <div class="range-row">
        <input type="range" id="detect-conf" min="0.1" max="0.9" step="0.05" value="0.45"
          oninput="document.getElementById('conf-val').textContent=this.value">
        <span class="range-val" id="conf-val">0.45</span>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="detect-faces" checked>
        <label for="detect-faces">Enable Face Recognition</label>
      </div>
      <label>Face Similarity Threshold</label>
      <div class="range-row">
        <input type="range" id="detect-face-thr" min="0.20" max="0.80" step="0.05" value="0.45"
          oninput="document.getElementById('fthr-val').textContent=this.value">
        <span class="range-val" id="fthr-val">0.45</span>
      </div>
      <button class="btn btn-primary" onclick="detectImage()">â—Ž Detect PPE + Face</button>
      <div id="detect-result" style="margin-top:16px"></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-icon">â–¦</div><div class="card-title">Result</div></div>
      <div id="detect-preview" class="empty-state" data-icon="â—Ž">Upload image and run detection</div>
    </div>
  </div>
</div>

<!-- ===== DETECT VIDEO ===== -->
<div class="panel" id="panel-video">
  <div class="section-header">
    <div class="section-title">Video Detection</div>
    <div class="section-sub">Frame-by-frame compliance analysis</div>
  </div>
  <div class="grid-2">
    <div class="card">
      <div class="card-header"><div class="card-icon">â–¶</div><div class="card-title">Video File</div></div>
      <label>Upload Video (MP4)</label>
      <input type="file" id="video-file" accept="video/*">
      <label>Skip Frames</label>
      <input type="number" id="video-skip" value="5" min="1" max="30">
      <label>Confidence</label>
      <div class="range-row">
        <input type="range" id="video-conf" min="0.1" max="0.9" step="0.05" value="0.45"
          oninput="document.getElementById('vconf-val').textContent=this.value">
        <span class="range-val" id="vconf-val">0.45</span>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="video-faces">
        <label for="video-faces">Face Recognition</label>
      </div>
      <button class="btn btn-primary" onclick="detectVideo()">â–¶ Process Video</button>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-icon">â–¶</div><div class="card-title">YouTube Video</div></div>
      <label>YouTube URL</label>
      <input type="text" id="yt-url" placeholder="https://www.youtube.com/watch?v=...">
      <label>Max Frames</label>
      <input type="number" id="yt-max" value="100" min="10" max="1000">
      <button class="btn btn-danger" onclick="detectYouTube()">â–¶ Process YouTube</button>
    </div>
  </div>
  <!-- INLINE VIDEO PLAYER -->
  <div class="card" id="vp-player-card" style="display:none;padding:0;overflow:hidden">
    <div class="card-header" style="padding:14px 16px 10px;border-bottom:1px solid var(--border)">
      <div class="card-icon">â–¶</div>
      <div class="card-title" id="vp-player-filename">Video Player</div>
      <div style="margin-left:auto">
        <button class="btn btn-ghost btn-sm" onclick="vpPlayerClose()">âœ• Close</button>
      </div>
    </div>
    <div class="vp-player-wrap" id="vp-player-wrap">
      <video id="vp-player-video" preload="metadata"></video>
      <canvas id="vp-overlay"></canvas>
    </div>
    <div class="vp-controls" id="vp-controls">
      <button class="vp-btn" id="vp-play-btn" onclick="vpTogglePlay()">â–¶ Play</button>
      <input type="range" class="vp-seek" id="vp-seek" value="0" min="0" step="0.01"
        oninput="vpSeek(this.value)">
      <span class="vp-time" id="vp-time">0:00 / 0:00</span>
      <select class="vp-speed-sel" onchange="vpSetSpeed(this.value)">
        <option value="0.25">0.25Ã—</option>
        <option value="0.5">0.5Ã—</option>
        <option value="1" selected>1Ã—</option>
        <option value="1.5">1.5Ã—</option>
        <option value="2">2Ã—</option>
      </select>
      <button class="vp-btn active" id="vp-labels-btn" onclick="vpToggleLabels()">Labels ON</button>
      <button class="vp-btn active" id="vp-boxes-btn" onclick="vpToggleBoxes()">Boxes ON</button>
      <button class="vp-btn" id="vp-download-btn" onclick="vpDownload()" title="Download do vÃ­deo">â¬‡ Download</button>
      <span class="vp-status-badge idle" id="vp-live-badge">â€”</span>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><div class="card-icon">â¬¡</div><div class="card-title">Results</div></div>
    <div id="video-result" class="empty-state" data-icon="â–¶">Upload a video or paste a YouTube URL</div>
  </div>
</div>

<!-- ===== LIVE STREAM ===== -->
<div class="panel" id="panel-stream">
  <div class="section-header">
    <div class="section-title">Live Stream</div>
    <div class="section-sub">Real-time PPE detection on camera feeds</div>
  </div>

  <!-- RTSP / STREAM CONFIG -->
  <div class="card">
    <div class="grid-3">
      <div>
        <label>Source Type</label>
        <select id="stream-type">
          <option value="rtsp">RTSP Camera</option>
          <option value="youtube">YouTube Live</option>
          <option value="webcam">Webcam</option>
          <option value="file">Video File</option>
        </select>
      </div>
      <div>
        <label>Source URL / Path</label>
        <input type="text" id="stream-source" placeholder="rtsp://admin:pass@192.168.1.100:554/stream">
      </div>
      <div>
        <label>Confidence</label>
        <div class="range-row">
          <input type="range" id="stream-conf" min="0.1" max="0.9" step="0.05" value="0.45"
            oninput="document.getElementById('sconf-val').textContent=this.value">
          <span class="range-val" id="sconf-val">0.45</span>
        </div>
      </div>
    </div>
    <div class="grid-2">
      <div>
        <div class="checkbox-row">
          <input type="checkbox" id="stream-faces" checked>
          <label for="stream-faces">Face Recognition</label>
        </div>
        <label>Face Threshold</label>
        <div class="range-row">
          <input type="range" id="stream-face-thr" min="0.20" max="0.80" step="0.05" value="0.45"
            oninput="document.getElementById('sfthr-val').textContent=this.value">
          <span class="range-val" id="sfthr-val">0.45</span>
        </div>
      </div>
      <div style="padding-top:8px">
        <div class="btn-group">
          <button class="btn btn-success" onclick="startStream()">â—ˆ Start</button>
          <button class="btn btn-danger" onclick="stopStream()">â—¼ Stop</button>
          <button class="btn btn-ghost btn-sm" onclick="refreshSessions()">â†» Sessions</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LIVE FEED + INFO -->
  <div class="grid-2">
    <div class="card">
      <div class="card-header"><div class="card-icon">â—ˆ</div><div class="card-title">Live Feed</div></div>
      <div class="stream-container" id="stream-container">
        <div class="stream-placeholder">No stream active</div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-header"><div class="card-icon">â¬¡</div><div class="card-title">Stream Info</div></div>
        <div id="stream-info" class="empty-state" data-icon="â—ˆ">Start a stream</div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-icon">â—‰</div><div class="card-title">Active Sessions</div></div>
        <div id="stream-sessions" class="empty-state" data-icon="â—‰">No active sessions</div>
      </div>
    </div>
  </div>

  <!-- ===== BROWSER CAMERA (dentro do panel-stream) ===== -->
  <div class="card" style="margin-top:16px">
    <div class="card-header">
      <div class="card-icon">ðŸ“·</div>
      <div class="card-title">Browser Camera â€” DetecÃ§Ã£o em Tempo Real</div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <span class="badge badge-off" id="cam-badge">INATIVO</span>
      </div>
    </div>

    <!-- CONTROLS ROW -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;margin-bottom:14px;align-items:end">
      <div>
        <label>Confidence</label>
        <div class="range-row">
          <input type="range" id="cam-conf" min="0.1" max="0.9" step="0.05" value="0.4"
            oninput="document.getElementById('cam-conf-val').textContent=this.value">
          <span class="range-val" id="cam-conf-val">0.4</span>
        </div>
      </div>
      <div>
        <label>Intervalo (ms)</label>
        <select id="cam-interval" style="margin-bottom:0">
          <option value="100">100ms â€” ~10fps</option>
          <option value="200" selected>200ms â€” ~5fps</option>
          <option value="500">500ms â€” ~2fps</option>
          <option value="1000">1000ms â€” ~1fps</option>
        </select>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <div class="checkbox-row" style="margin:0">
          <input type="checkbox" id="cam-faces" checked>
          <label for="cam-faces" style="font-size:12px">Face Recognition</label>
        </div>
        <div class="checkbox-row" style="margin:0">
          <input type="checkbox" id="cam-mirror" checked onchange="camToggleMirror()">
          <label for="cam-mirror" style="font-size:12px">Espelhar imagem</label>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-success" id="cam-start-btn" onclick="camStart()">ðŸ“· Iniciar CÃ¢mera</button>
        <button class="btn btn-danger" id="cam-stop-btn" onclick="camStop()" style="display:none">â—¼ Parar</button>
      </div>
    </div>

    <!-- CAMERA VIEW -->
    <div class="grid-2" style="gap:16px">
      <div class="cam-container" id="cam-container">
        <div class="cam-placeholder" id="cam-placeholder">Clique em "Iniciar CÃ¢mera" para<br>usar a cÃ¢mera do seu dispositivo</div>
        <video id="cam-video" autoplay playsinline muted style="display:none"></video>
        <canvas id="cam-canvas" style="display:none"></canvas>
        <img id="cam-result-img" class="cam-result" style="display:none" alt="resultado">
        <div class="cam-overlay cam-scanline" id="cam-scanline"></div>
        <div class="cam-status-bar" id="cam-status-bar" style="display:none">
          <span class="cam-fps-badge" id="cam-fps-badge">0 FPS</span>
          <span class="cam-fps-badge" id="cam-compliance-badge">â€”</span>
          <span class="cam-fps-badge" id="cam-ms-badge">â€” ms</span>
        </div>
        <select class="cam-selector" id="cam-device-sel" onchange="camSwitchDevice()"></select>
        <button class="cam-mirror-btn" id="cam-mirror-btn" onclick="document.getElementById('cam-mirror').click()">âŸº Espelhar</button>
      </div>

      <!-- RESULT SIDEBAR -->
      <div>
        <div class="card" style="margin-bottom:0;height:100%">
          <div class="card-header" style="padding-bottom:10px;margin-bottom:12px">
            <div class="card-icon">â—Ž</div>
            <div class="card-title">Ãšltimo Resultado</div>
          </div>
          <div id="cam-result-detail" class="empty-state" data-icon="ðŸ“·">Aguardando detecÃ§Ã£o...</div>
        </div>
      </div>
    </div>
  </div>
  <!-- ===== FIM BROWSER CAMERA ===== -->

</div><!-- fim panel-stream -->


<!-- ===== FILE BROWSER ===== -->
<div class="panel" id="panel-files">
  <div class="section-header">
    <div class="section-title">File Browser</div>
    <div class="section-sub">Visualize, baixe e gerencie arquivos do servidor</div>
  </div>

  <div class="grid-4" style="margin-bottom:16px" id="fb-stats-row">
    <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value" id="fb-stat-size">â€”</div><div class="stat-sub">em disco</div></div>
    <div class="stat-card"><div class="stat-label">Arquivos</div><div class="stat-value" id="fb-stat-files">â€”</div><div class="stat-sub">no servidor</div></div>
    <div class="stat-card"><div class="stat-label">Imagens</div><div class="stat-value" id="fb-stat-imgs">â€”</div><div class="stat-sub">fotos e frames</div></div>
    <div class="stat-card"><div class="stat-label">Modelos</div><div class="stat-value" id="fb-stat-models">â€”</div><div class="stat-sub">arquivos .pt</div></div>
  </div>

  <div class="card" style="padding:16px 20px">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px">
      <div id="fb-breadcrumb" style="display:flex;align-items:center;gap:4px;flex:1;min-width:0;overflow-x:auto;scrollbar-width:none;padding:6px 0"></div>
      <div style="display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap">
        <button class="btn btn-ghost btn-sm" onclick="fbRefresh()">â†» Atualizar</button>
        <button class="btn btn-ghost btn-sm" onclick="fbToggleView()" id="fb-view-btn">âŠž Grid</button>
        <button class="btn btn-primary btn-sm" onclick="fbShowUploadModal()">â¬† Upload</button>
        <button class="btn btn-ghost btn-sm" onclick="fbShowMkdirModal()">ðŸ“ Nova Pasta</button>
      </div>
    </div>
    <div style="position:relative;margin-bottom:14px">
      <input type="text" id="fb-search" placeholder="ðŸ”  Filtrar arquivos..." oninput="fbFilter(this.value)"
        style="margin:0;padding-left:16px;font-size:13px">
    </div>
    <div id="fb-container">
      <div class="empty-state" data-icon="ðŸ—‚">Carregando...</div>
    </div>
  </div>

  <!-- IMAGE LIGHTBOX -->
  <div id="fb-lightbox" onclick="fbCloseLightbox()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:10000;cursor:zoom-out;align-items:center;justify-content:center;flex-direction:column;gap:16px">
    <img id="fb-lightbox-img" src="" style="max-width:90vw;max-height:80vh;border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,0.6);object-fit:contain">
    <div style="display:flex;align-items:center;gap:12px">
      <span id="fb-lightbox-name" style="color:#fff;font-family:Space Mono,monospace;font-size:12px"></span>
      <a id="fb-lightbox-dl" href="#" download style="color:#63b3ed;font-size:12px;font-family:Space Mono,monospace" onclick="event.stopPropagation()">â¬‡ Download</a>
    </div>
  </div>
</div>

<!-- ===== FILE BROWSER: UPLOAD MODAL ===== -->
<div class="fb-modal-backdrop" id="fb-upload-modal" onclick="fbHideUploadModal(event)">
  <div class="fb-modal" onclick="event.stopPropagation()">
    <button class="fb-modal-close" onclick="fbHideUploadModal()">âœ•</button>
    <div class="fb-modal-title">â¬† Upload de Arquivos</div>
    <label style="margin-bottom:4px">Pasta destino</label>
    <input type="text" id="fb-upload-dest" readonly style="margin-bottom:14px;background:var(--surface3);cursor:default;font-family:Space Mono,monospace;font-size:12px">
    <div class="fb-dropzone" id="fb-dropzone"
      onclick="document.getElementById('fb-upload-input').click()"
      ondragover="fbDragOver(event)" ondragleave="fbDragLeave(event)" ondrop="fbDrop(event)">
      <div class="fb-dropzone-icon">â¬†</div>
      <div class="fb-dropzone-text">Clique ou arraste arquivos aqui</div>
      <div class="fb-dropzone-sub">Qualquer arquivo suportado Â· max 500 MB cada</div>
    </div>
    <input type="file" id="fb-upload-input" multiple style="display:none" onchange="fbAddFiles(this.files)">
    <div class="fb-queue" id="fb-queue"></div>
    <div class="fb-upload-progress" id="fb-upload-progress">
      <div class="fb-upload-progress-label">
        <span id="fb-prog-label">Enviando...</span>
        <span id="fb-prog-pct">0%</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="fb-prog-fill" style="width:0%"></div></div>
    </div>
    <div id="fb-upload-msg" style="min-height:20px;margin-bottom:10px"></div>
    <div class="btn-group">
      <button class="btn btn-primary" id="fb-upload-btn" onclick="fbDoUpload()">â¬† Enviar Arquivos</button>
      <button class="btn btn-ghost" onclick="fbHideUploadModal()">Cancelar</button>
      <button class="btn btn-ghost btn-sm" onclick="fbClearQueue()">âœ• Limpar</button>
    </div>
  </div>
</div>

<!-- ===== FILE BROWSER: MKDIR MODAL ===== -->
<div class="fb-modal-backdrop" id="fb-mkdir-modal" onclick="fbHideMkdirModal(event)">
  <div class="fb-modal" onclick="event.stopPropagation()" style="width:360px">
    <button class="fb-modal-close" onclick="fbHideMkdirModal()">âœ•</button>
    <div class="fb-modal-title">ðŸ“ Nova Pasta</div>
    <label>Nome da pasta</label>
    <input type="text" id="fb-mkdir-name" placeholder="ex: fotos_capacete"
      onkeydown="if(event.key==='Enter')fbDoMkdir()" style="margin-bottom:6px">
    <div id="fb-mkdir-path" style="font-family:Space Mono,monospace;font-size:11px;color:var(--text-muted);margin-bottom:14px"></div>
    <div id="fb-mkdir-msg" style="min-height:18px;margin-bottom:10px"></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="fbDoMkdir()">ðŸ“ Criar Pasta</button>
      <button class="btn btn-ghost" onclick="fbHideMkdirModal()">Cancelar</button>
    </div>
  </div>
</div>

</div><!-- fim .panels -->

<script>
let CID={{company_id}};
let _lastVideoFile = null;   // stores the last uploaded video File object
let _lastVideoFps  = 25;     // estimated FPS for seek calculation
let currentStreamId=null;
let streamPoll=null;
let annAnnotations=[];
let annDrawing=false;
let annStartX=0,annStartY=0;
let annImgW=0,annImgH=0;
let annCurrentFile='';
const classColors={0:'#FC8181',1:'#63B3ED',2:'#68D391',3:'#F6E05E',4:'#B794F4',5:'#F6AD55'};
const classNames={0:'thermal_coat',1:'thermal_pants',2:'gloves',3:'helmet',4:'boots',5:'person'};

function API(p){return'/api/v1/epi'+p+'?company_id='+CID}
function switchCompany(){
  CID=parseInt(document.getElementById('companySelect').value);
  const panelMap={dashboard:loadDashboard,config:loadPPEConfig,annotate:loadAnnotationImages,faces:loadPeople,train:pollTrainStatus};
  const activePanel=document.querySelector('.panel.active');
  if(activePanel){const id=activePanel.id.replace('panel-','');if(panelMap[id])panelMap[id]();}
  toast('Switched to Company '+CID);
}

function showPanel(n,el){
  stopTrainPoll();
  if(n!=='stream'&&_camStream)camStop();
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+n).classList.add('active');
  if(el)el.classList.add('active');
  if(n==='dashboard')loadDashboard();
  if(n==='config')loadPPEConfig();
  if(n==='annotate')loadAnnotationImages();
  if(n==='faces')loadPeople();
  if(n==='train')pollTrainStatus();
  if(n==='files')fbInit();
}

function toast(m,t='success'){
  const e=document.getElementById('toast');
  e.textContent=m;e.className='toast '+t;e.style.display='block';
  setTimeout(()=>e.style.display='none',3500);
}

// ---- DASHBOARD ----
async function loadDashboard(){
  try{
    const s=await(await fetch(API('/stats'))).json();
    const cfg=s.ppe_config||{};
    const active=Object.values(cfg).filter(v=>v).length;
    document.getElementById('stat-classes').textContent=active;
    document.getElementById('stat-models').textContent=s.models_count||0;
    document.getElementById('stat-people').textContent=s.people_count||0;
    document.getElementById('stat-storage').textContent=s.storage?.total_mb||0;
    document.getElementById('dash-classes').innerHTML=Object.entries(cfg).map(([k,v])=>'<span class="badge '+(v?'badge-ok':'badge-off')+'" style="margin:2px">'+k+'</span>').join('');
    const ts=s.train_status||{};
    const statusMap={'complete':'ok','training':'warn','error':'err','idle':'off'};
    document.getElementById('dash-train').innerHTML=
      '<div class="info-row"><span class="info-key">STATUS</span><span class="info-val"><span class="badge badge-'+(statusMap[ts.status]||'off')+'">'+(ts.status||'idle')+'</span></span></div>'+
      (ts.status==='training'?'<div class="progress-bar" style="margin-top:10px"><div class="progress-fill training-pulse" style="width:'+((ts.epoch/ts.total_epochs*100)||5)+'%"></div></div>':'');
    const p=await(await fetch(API('/photos/summary'))).json();
    const photoRows=Object.entries(p).map(([k,v])=>'<tr><td>'+k+'</td><td><span class="badge badge-blue">'+v+'</span></td></tr>').join('');
    document.getElementById('dash-photos').innerHTML='<table><tr><th>Category</th><th>Photos</th></tr>'+photoRows+'</table>';
    const a=await(await fetch(API('/annotations/status'))).json();
    document.getElementById('dash-annotations').innerHTML=
      '<div class="info-row"><span class="info-key">ANNOTATED</span><span class="info-val">'+a.annotated_images+' / '+a.total_images+'</span></div>'+
      Object.entries(a.class_counts||{}).map(([k,v])=>'<div class="info-row"><span class="info-key">'+k+'</span><span class="info-val">'+v+'</span></div>').join('');
  }catch(e){console.error(e)}
}

// ---- CONFIG ----
async function loadPPEConfig(){
  const d=await(await fetch(API('/config'))).json();
  document.getElementById('config-checkboxes').innerHTML=Object.entries(d.config).map(([k,v])=>
    '<div class="ppe-item"><input type="checkbox" id="cfg-'+k+'" '+(v?'checked':'')+'><label for="cfg-'+k+'">'+k+'</label></div>'
  ).join('');
}
async function savePPEConfig(){
  const c={};
  document.querySelectorAll('[id^="cfg-"]').forEach(e=>{c[e.id.replace('cfg-','')]=e.checked});
  await fetch(API('/config'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(c)});
  toast('PPE configuration saved');loadAnnotationClasses();
}

// ---- UPLOAD ----
async function uploadPhotos(){
  const f=document.getElementById('upload-files').files;
  if(!f.length)return toast('Select files first','error');
  const cat=document.getElementById('upload-category').value;
  const el=document.getElementById('upload-result');
  el.innerHTML='<span class="badge badge-warn">Uploading '+f.length+' files to '+cat+'...</span>';
  try{
    const fd=new FormData();fd.append('category',cat);for(const x of f)fd.append('files',x);
    const resp=await fetch(API('/upload/photos'),{method:'POST',body:fd});
    if(!resp.ok){const err=await resp.json().catch(()=>({detail:resp.statusText}));el.innerHTML='<span class="badge badge-err">'+(err.detail||resp.statusText)+'</span>';toast('Upload failed','error');return;}
    const r=await resp.json();
    el.innerHTML='<span class="badge badge-ok">'+(r.uploaded||0)+' photos uploaded to '+cat+'</span>';
    toast((r.uploaded||0)+' photos uploaded');
    document.getElementById('upload-files').value='';
  }catch(e){el.innerHTML='<span class="badge badge-err">'+e.message+'</span>';toast('Upload error','error');}
}

async function bulkUpload(){
  const f=document.getElementById('bulk-files').files;
  if(!f.length)return toast('Select files first','error');
  const cat=document.getElementById('bulk-category').value;
  const el=document.getElementById('bulk-result');
  el.innerHTML='<span class="badge badge-warn">Uploading '+f.length+' files...</span>';
  try{
    const fd=new FormData();fd.append('category',cat);fd.append('remap_json',document.getElementById('bulk-remap').value);for(const x of f)fd.append('files',x);
    const resp=await fetch(API('/upload/bulk'),{method:'POST',body:fd});
    if(!resp.ok){const err=await resp.json().catch(()=>({detail:resp.statusText}));el.innerHTML='<span class="badge badge-err">'+(err.detail||resp.statusText)+'</span>';toast('Bulk upload failed','error');return;}
    const r=await resp.json();
    el.innerHTML='<span class="badge badge-ok">'+(r.paired||0)+' paired</span> <span class="badge badge-warn">'+(r.images_only||0)+' image-only</span>';
    toast('Bulk: '+(r.paired||0)+' paired');
  }catch(e){el.innerHTML='<span class="badge badge-err">'+e.message+'</span>';toast('Bulk error','error');}
}

// ---- CONVERTER ----
async function convertUpload(){
  const f=document.getElementById('conv-files').files;
  if(!f.length)return toast('Select files first','error');
  const el=document.getElementById('conv-result');
  el.innerHTML='<span class="badge badge-warn">Converting...</span>';
  try{
    const fd=new FormData();fd.append('remap_json',document.getElementById('conv-remap').value);for(const x of f)fd.append('files',x);
    const resp=await fetch(API('/convert/upload'),{method:'POST',body:fd});
    if(!resp.ok){const err=await resp.json().catch(()=>({detail:resp.statusText}));el.innerHTML='<span class="badge badge-err">'+(err.detail||resp.statusText)+'</span>';toast('Convert failed','error');return;}
    const r=await resp.json();
    el.innerHTML='<span class="badge badge-ok">'+(r.files_converted||0)+' files converted</span> Â· '+(r.boxes_converted||0)+' boxes';
    toast((r.files_converted||0)+' files converted');
  }catch(e){el.innerHTML='<span class="badge badge-err">'+e.message+'</span>';toast('Convert error','error');}
}

// ---- ANNOTATE ----
function loadAnnotationClasses(){
  const sel=document.getElementById('ann-class');sel.innerHTML='';
  for(let i=0;i<=5;i++){const o=document.createElement('option');o.value=i;o.textContent=i+' â€” '+classNames[i];sel.appendChild(o)}
}
async function loadAnnotationImages(){
  loadAnnotationClasses();
  const imgs=await(await fetch(API('/annotate/images'))).json();
  const sel=document.getElementById('ann-image-sel');
  sel.innerHTML='<option value="">â€” Select Image â€”</option>';
  imgs.forEach(im=>{const o=document.createElement('option');o.value=im.name;o.textContent=im.name+(im.has_label?' âœ“':'');sel.appendChild(o)});
}
async function loadAnnotationImage(){
  const name=document.getElementById('ann-image-sel').value;if(!name)return;
  annCurrentFile=name;annAnnotations=[];
  const wrap=document.getElementById('ann-canvas-wrap');
  const imgEl=new Image();
  imgEl.onload=function(){
    annImgW=this.width;annImgH=this.height;
    let dw=Math.min(900,annImgW);let scale=dw/annImgW;let dh=Math.round(annImgH*scale);
    wrap.innerHTML='<img id="ann-bg" src="'+this.src+'" width="'+dw+'" height="'+dh+'" style="border-radius:8px"><canvas id="ann-cv" width="'+dw+'" height="'+dh+'"></canvas>';
    annImgW=dw;annImgH=dh;setupCanvas();
  };
  imgEl.src=API('/annotate/image/'+name);
  const lb=await(await fetch(API('/annotate/labels/'+name))).json();
  if(lb.labels&&lb.labels.length){
    lb.labels.forEach(l=>{const cx=l.cx*annImgW,cy=l.cy*annImgH,bw=l.w*annImgW,bh=l.h*annImgH;annAnnotations.push({class_id:l.class_id,cx:l.cx,cy:l.cy,w:l.w,h:l.h,x1:cx-bw/2,y1:cy-bh/2,x2:cx+bw/2,y2:cy+bh/2})});
    setTimeout(annRedraw,300);
  }
}
function setupCanvas(){
  const cv=document.getElementById('ann-cv');if(!cv)return;
  const ctx=cv.getContext('2d');
  cv.addEventListener('mousedown',e=>{const r=cv.getBoundingClientRect();annStartX=e.clientX-r.left;annStartY=e.clientY-r.top;annDrawing=true});
  cv.addEventListener('mousemove',e=>{if(!annDrawing)return;const r=cv.getBoundingClientRect();const x=e.clientX-r.left,y=e.clientY-r.top;annRedraw();ctx.strokeStyle='rgba(99,179,237,0.8)';ctx.lineWidth=2;ctx.setLineDash([5,5]);ctx.strokeRect(annStartX,annStartY,x-annStartX,y-annStartY);ctx.setLineDash([])});
  cv.addEventListener('mouseup',e=>{if(!annDrawing)return;annDrawing=false;const r=cv.getBoundingClientRect();const x=e.clientX-r.left,y=e.clientY-r.top;const x1=Math.min(annStartX,x),y1=Math.min(annStartY,y),x2=Math.max(annStartX,x),y2=Math.max(annStartY,y);if(x2-x1<5||y2-y1<5)return;const cid=parseInt(document.getElementById('ann-class').value);annAnnotations.push({class_id:cid,cx:((x1+x2)/2)/annImgW,cy:((y1+y2)/2)/annImgH,w:(x2-x1)/annImgW,h:(y2-y1)/annImgH,x1,y1,x2,y2});annRedraw();logAnn(cid,annAnnotations.length)});
}
function annRedraw(){
  const cv=document.getElementById('ann-cv');if(!cv)return;
  const ctx=cv.getContext('2d');ctx.clearRect(0,0,annImgW,annImgH);
  annAnnotations.forEach(a=>{const c=classColors[a.class_id]||'#63B3ED';ctx.strokeStyle=c;ctx.lineWidth=2;ctx.strokeRect(a.x1,a.y1,a.x2-a.x1,a.y2-a.y1);ctx.fillStyle=c+'33';ctx.fillRect(a.x1,a.y1,a.x2-a.x1,a.y2-a.y1);ctx.fillStyle=c;ctx.font='bold 11px Space Mono, monospace';ctx.fillText(classNames[a.class_id]||('cls'+a.class_id),a.x1+4,a.y1+14)});
}
function logAnn(cid,n){document.getElementById('ann-log').innerHTML+='['+n+'] '+classNames[cid]+' added<br>'}
function annUndo(){if(annAnnotations.length){annAnnotations.pop();annRedraw();document.getElementById('ann-log').innerHTML+='â†© undo<br>'}}
function annClear(){annAnnotations=[];annRedraw();document.getElementById('ann-log').innerHTML='âœ• cleared<br>'}
async function annSave(){
  if(!annCurrentFile)return toast('No image selected','error');
  const cv=document.getElementById('ann-cv');
  if(!cv)return toast('No canvas found','error');
  if(!annAnnotations.length)return toast('No annotations to save','error');
  const data=annAnnotations.map(a=>({class_id:a.class_id,cx:a.cx,cy:a.cy,w:a.w,h:a.h}));
  const r=await(await fetch(API('/annotate/save'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image_filename:annCurrentFile,annotations:data})})).json();
  toast('Saved '+r.saved+' annotations');document.getElementById('ann-log').innerHTML+='âœ“ saved '+r.saved+'<br>';
}

// ======================== TRAIN ========================
function setTrainLoading(loading){
  const btn=document.getElementById('btn-start-train');
  const icon=document.getElementById('btn-train-icon');
  const txt=document.getElementById('btn-train-text');
  if(loading){btn.disabled=true;btn.style.opacity='0.75';btn.style.cursor='not-allowed';icon.innerHTML='<span class="train-spinner"></span>';txt.textContent='Training...';}
  else{btn.disabled=false;btn.style.opacity='';btn.style.cursor='';icon.textContent='âš™';txt.textContent='Start Training';}
}

async function generateDataset(){
  const el=document.getElementById('dataset-result');
  el.innerHTML='<span class="badge badge-warn">Generating dataset...</span>';
  try{
    const fd=new FormData();fd.append('train_split',document.getElementById('train-split').value);
    const resp=await fetch(API('/dataset/generate'),{method:'POST',body:fd});
    const r=await resp.json();
    if(!resp.ok||r.error||r.detail){const msg=r.detail||r.error||'Unknown error';el.innerHTML='<span class="badge badge-err">'+msg+'</span>';toast(msg,'error');return;}
    el.innerHTML='<span class="badge badge-ok">'+(r.train||0)+' train / '+(r.valid||0)+' valid</span>';
    if(r.classes)el.innerHTML+='<div style="margin-top:8px;font-size:12px;color:var(--text-muted)">Classes: '+Object.values(r.classes).join(' Â· ')+'</div>';
    toast('Dataset generated successfully');
  }catch(e){el.innerHTML='<span class="badge badge-err">'+e.message+'</span>';toast('Dataset failed','error');}
}

async function startTraining(){
  const b={base_model:document.getElementById('train-model').value,epochs:parseInt(document.getElementById('train-epochs').value),batch_size:parseInt(document.getElementById('train-batch').value),img_size:parseInt(document.getElementById('train-imgsz').value),patience:parseInt(document.getElementById('train-patience').value)};
  const resp=await fetch(API('/train/start'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
  const r=await resp.json().catch(()=>({}));
  if(!resp.ok){toast(r.detail||'Failed to start training','error');return;}
  toast('Training started âš™');
  setTrainLoading(true);
  document.getElementById('train-download').style.display='none';
  const sa=document.getElementById('train-status-area');
  sa.style.display='flex';
  sa.innerHTML='<span class="badge badge-warn" style="font-size:12px">âš™ Initializing...</span>';
  pollTrainStatus();
}

let _trainPollTimer=null;
function stopTrainPoll(){if(_trainPollTimer){clearTimeout(_trainPollTimer);_trainPollTimer=null;}}

async function pollTrainStatus(){
  stopTrainPoll();
  let r;
  try{r=await(await fetch(API('/train/status'))).json();}
  catch(e){_trainPollTimer=setTimeout(pollTrainStatus,5000);return;}
  const sa=document.getElementById('train-status-area');
  const dl=document.getElementById('train-download');
  if(r.status==='training'){
    setTrainLoading(true);sa.style.display='flex';
    const pct=r.total_epochs?Math.round((r.epoch/r.total_epochs)*100):5;
    const elapsed=r.elapsed_seconds?formatDuration(r.elapsed_seconds):'';
    sa.innerHTML='<div style="width:100%"><div class="train-epoch-row"><span class="train-epoch-label">EPOCH '+(r.epoch??'?')+' / '+(r.total_epochs??'?')+'</span><span class="train-epoch-pct">'+pct+'%</span></div><div class="progress-bar"><div class="progress-fill training-pulse" style="width:'+pct+'%"></div></div>'+(elapsed?'<div class="train-meta">â± '+elapsed+' elapsed</div>':'')+(r.box_loss?'<div class="train-meta" style="margin-top:2px">loss â†’ box: '+r.box_loss+' Â· cls: '+r.cls_loss+'</div>':'')+'</div>';
    dl.style.display='none';_trainPollTimer=setTimeout(pollTrainStatus,4000);
  }else if(r.status==='complete'){
    setTrainLoading(false);stopTrainPoll();
    const mp=r.model_path||'';const fname=mp.split(/[/\\]/).pop()||'best.pt';
    sa.style.display='flex';
    sa.innerHTML='<span class="badge badge-ok" style="font-size:12px;padding:5px 14px">âœ“ Training Complete</span>'+(mp?'<div class="train-meta" style="margin-top:4px;word-break:break-all">'+mp+'</div>':'');
    dl.style.display='block';
    dl.innerHTML='<div class="train-download-box"><span class="dl-icon">â¬‡</span><div class="dl-info"><div class="dl-label">Model ready for download</div><div class="dl-path">'+fname+'</div></div><a class="btn btn-primary btn-sm" href="'+API('/train/download')+'" download="'+fname+'" style="text-decoration:none;flex-shrink:0">Download .pt</a></div>';
    toast('âœ“ Training complete! Model ready to download.');
  }else if(r.status==='error'){
    setTrainLoading(false);stopTrainPoll();
    sa.style.display='flex';sa.innerHTML='<span class="badge badge-err" style="font-size:12px">âœ— Error: '+(r.error||'unknown')+'</span>';
    toast('Training error: '+(r.error||'unknown'),'error');
  }else{
    setTrainLoading(false);sa.style.display='flex';
    sa.innerHTML='<span class="badge badge-off">'+(r.status||'idle')+'</span>';dl.style.display='none';
  }
}

function formatDuration(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;if(h>0)return h+'h '+m+'m';if(m>0)return m+'m '+sec+'s';return sec+'s';}

// ---- DETECT IMAGE ----
function previewDetect(i){if(i.files[0]){const r=new FileReader();r.onload=e=>document.getElementById('detect-preview').innerHTML='<img src="'+e.target.result+'" class="preview-img">';r.readAsDataURL(i.files[0])}}
async function detectImage(){
  const f=document.getElementById('detect-file').files[0];if(!f)return toast('Select image first','error');
  const fd=new FormData();fd.append('file',f);fd.append('confidence',document.getElementById('detect-conf').value);fd.append('detect_faces',document.getElementById('detect-faces').checked);fd.append('face_threshold',document.getElementById('detect-face-thr').value);
  const r=await(await fetch(API('/detect/upload'),{method:'POST',body:fd})).json();
  document.getElementById('detect-preview').innerHTML='<img src="data:image/jpeg;base64,'+r.annotated_base64+'" class="preview-img">';
  let html='<div class="result-box '+(r.compliant?'result-compliant':'result-noncompliant')+'">';
  html+='<div class="result-title '+(r.compliant?'ok':'fail')+'">'+(r.compliant?'âœ“ COMPLIANT':'âœ— NON-COMPLIANT')+'</div>';
  html+='<div style="font-size:13px;color:var(--text-muted)">Detected: '+r.detected_count+'/'+r.required_count+' PPEs</div>';
  if(r.missing&&r.missing.length)html+='<div style="margin-top:8px">Missing: <span style="color:var(--danger)">'+r.missing.join(', ')+'</span></div>';
  if(r.faces&&r.faces.length){r.faces.forEach(fc=>{html+='<div style="margin-top:4px">Person: <strong>'+fc.person_name+'</strong> ('+Math.round(fc.confidence*100)+'%)</div>'})}
  html+='<div style="margin-top:8px;font-size:11px;color:var(--text-dim);font-family:Space Mono,monospace">'+r.processing_ms+'ms</div></div>';
  document.getElementById('detect-result').innerHTML=html;
}

// ---- VIDEO ----
async function detectVideo(){
  const f=document.getElementById('video-file').files[0];
  if(!f)return toast('Select video first','error');
  const el=document.getElementById('video-result');
  el.innerHTML='<div style="padding:32px;text-align:center;font-family:Space Mono,monospace;color:var(--text-muted)">'+
    '<div style="font-size:28px;margin-bottom:12px">â³</div>'+
    '<div>Processing video <strong>'+f.name+'</strong>...</div>'+
    '<div style="font-size:12px;margin-top:8px;color:var(--text-dim)">This may take a few minutes depending on video length</div></div>';
  try{
    _lastVideoFile = f;  // store for frame preview
    const fd=new FormData();
    fd.append('file',f);
    fd.append('skip_frames',document.getElementById('video-skip').value);
    fd.append('confidence',document.getElementById('video-conf').value);
    fd.append('detect_faces',document.getElementById('video-faces').checked);
    const resp=await fetch(API('/detect/video'),{method:'POST',body:fd});
    if(!resp.ok){
      const err=await resp.json().catch(()=>({detail:resp.statusText}));
      el.innerHTML='<div class="result-box result-noncompliant"><div class="result-title fail">âœ— Processing Failed</div>'+
        '<div style="font-size:13px;margin-top:8px;color:var(--text-muted)">'+(err.detail||resp.statusText)+'</div></div>';
      toast('Video processing failed: '+(err.detail||resp.statusText),'error');
      return;
    }
    const r=await resp.json();
    showVideoResult(r, f.name);
    vpPlayerOpen(f, r.details || []);
  }catch(e){
    console.error('detectVideo error:',e);
    el.innerHTML='<div class="result-box result-noncompliant"><div class="result-title fail">âœ— Error</div>'+
      '<div style="font-size:13px;margin-top:8px">'+e.message+'</div></div>';
    toast('Video error: '+e.message,'error');
  }
}
async function detectYouTube(){
  const u=document.getElementById('yt-url').value;
  if(!u)return toast('Enter YouTube URL','error');
  const el=document.getElementById('video-result');
  el.innerHTML='<div style="padding:32px;text-align:center;font-family:Space Mono,monospace;color:var(--text-muted)">'+
    '<div style="font-size:28px;margin-bottom:12px">â¬‡</div>'+
    '<div>Downloading & processing YouTube video...</div>'+
    '<div style="font-size:12px;margin-top:8px;color:var(--text-dim)">This may take several minutes</div></div>';
  try{
    const fd=new FormData();
    fd.append('url',u);
    fd.append('max_frames',document.getElementById('yt-max').value);
    const resp=await fetch(API('/detect/youtube'),{method:'POST',body:fd});
    if(!resp.ok){
      const err=await resp.json().catch(()=>({detail:resp.statusText}));
      el.innerHTML='<div class="result-box result-noncompliant"><div class="result-title fail">âœ— Failed</div>'+
        '<div style="font-size:13px;margin-top:8px">'+(err.detail||resp.statusText)+'</div></div>';
      toast('YouTube processing failed','error');
      return;
    }
    const r=await resp.json();
    showVideoResult(r, u);
  }catch(e){
    console.error('detectYouTube error:',e);
    el.innerHTML='<div class="result-box result-noncompliant"><div class="result-title fail">âœ— Error</div>'+
      '<div style="font-size:13px;margin-top:8px">'+e.message+'</div></div>';
    toast('YouTube error: '+e.message,'error');
  }
}
function showVideoResult(r, sourceName){
  const rate = typeof r.compliance_rate === 'number' ? r.compliance_rate : 0;
  const badgeCls = rate >= 80 ? 'badge-ok' : rate >= 50 ? 'badge-warn' : 'badge-err';
  const details  = Array.isArray(r.details) ? r.details : [];

  // â”€â”€ compute missing EPIs summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const missingCount = {};
  details.forEach(d => {
    (d.missing || []).forEach(m => { missingCount[m] = (missingCount[m]||0)+1; });
  });
  const missingSorted = Object.entries(missingCount).sort((a,b)=>b[1]-a[1]);

  // â”€â”€ summary header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let html = '<div class="grid-4" style="margin-bottom:16px">';
  html += '<div class="stat-card"><div class="stat-label">Frames Processed</div><div class="stat-value">'+r.frames_processed+'</div></div>';
  html += '<div class="stat-card"><div class="stat-label">Compliant</div><div class="stat-value" style="color:var(--success)">'+r.compliant_frames+'</div></div>';
  html += '<div class="stat-card"><div class="stat-label">Non-Compliant</div><div class="stat-value" style="color:var(--danger)">'+r.non_compliant_frames+'</div></div>';
  html += '<div class="stat-card"><div class="stat-label">Compliance Rate</div>';
  html += '<div class="stat-value" style="color:'+(rate>=80?'var(--success)':rate>=50?'var(--warning)':'var(--danger)')+'">'+rate.toFixed(1)+'%</div></div>';
  html += '</div>';

  // â”€â”€ verdict badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">';
  html += '<span class="badge '+badgeCls+'" style="font-size:13px;padding:6px 16px">';
  html += rate >= 80 ? 'âœ“ COMPLIANT' : rate >= 50 ? 'âš  PARTIALLY COMPLIANT' : 'âœ— NON-COMPLIANT';
  html += '</span>';
  if(sourceName) html += '<span style="font-family:Space Mono,monospace;font-size:11px;color:var(--text-dim)">'+sourceName+'</span>';
  html += '</div>';

  // â”€â”€ most missing EPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(missingSorted.length){
    html += '<div class="card" style="margin-bottom:16px;padding:14px 16px">';
    html += '<div style="font-size:11px;font-family:Space Mono,monospace;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px">Most Missing EPIs</div>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:8px">';
    missingSorted.forEach(([name, cnt]) => {
      const pct = details.length ? Math.round(cnt/details.length*100) : 0;
      html += '<div style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--danger-dim);border:1px solid rgba(217,48,37,0.2);border-radius:8px">';
      html += '<span style="font-size:13px;font-weight:600;color:var(--danger)">'+name+'</span>';
      html += '<span style="font-size:11px;color:var(--text-muted);font-family:Space Mono,monospace">'+cnt+' frames ('+pct+'%)</span>';
      html += '</div>';
    });
    html += '</div></div>';
  }

  // â”€â”€ frame details table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(details.length){
    html += '<div class="card" style="padding:14px 16px">';
    html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">';
    html += '<div style="font-size:11px;font-family:Space Mono,monospace;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em">Frame Details ('+details.length+' sampled)</div>';
    html += '</div>';
    html += '<div style="max-height:360px;overflow-y:auto;border-radius:8px;border:1px solid var(--border)">';
    html += '<table style="font-size:12px">';
    html += '<thead><tr>';
    html += '<th style="position:sticky;top:0;background:var(--surface2)">Frame #</th>';
    html += '<th style="position:sticky;top:0;background:var(--surface2)">Status</th>';
    html += '<th style="position:sticky;top:0;background:var(--surface2)">Detected</th>';
    html += '<th style="position:sticky;top:0;background:var(--surface2)">Missing EPIs</th>';
    html += '<th style="position:sticky;top:0;background:var(--surface2)">Detections</th>';
    html += '<th style="position:sticky;top:0;background:var(--surface2)">Time</th>';
    html += '<th style="position:sticky;top:0;background:var(--surface2)">Preview</th>';
    html += '</tr></thead><tbody>';

    details.forEach(d => {
      const ok = d.compliant;
      const rowBg = ok ? 'rgba(30,140,69,0.04)' : 'rgba(217,48,37,0.04)';
      html += '<tr style="background:'+rowBg+'">';
      html += '<td style="font-family:Space Mono,monospace;color:var(--text-muted)">'+( d.frame_number||'â€”')+'</td>';
      html += '<td><span class="badge '+(ok?'badge-ok':'badge-err')+'" style="font-size:10px">'+(ok?'âœ“ OK':'âœ— FAIL')+'</span></td>';
      html += '<td style="font-family:Space Mono,monospace;text-align:center">'+(d.detected_count||0)+'/'+(d.required_count||0)+'</td>';
      if(d.missing && d.missing.length){
        html += '<td><span style="color:var(--danger);font-size:11px">'+d.missing.join(', ')+'</span></td>';
      } else {
        html += '<td><span style="color:var(--success);font-size:11px">â€”</span></td>';
      }
      // detections badges
      html += '<td>';
      if(d.detections && d.detections.length){
        // deduplicate by class_name, keep highest conf
        const seen = {};
        d.detections.forEach(det => {
          if(!seen[det.class_name] || det.confidence > seen[det.class_name]) seen[det.class_name] = det.confidence;
        });
        Object.entries(seen).forEach(([cls, conf]) => {
          html += '<span class="badge badge-blue" style="font-size:9px;margin:1px">'+cls+' '+Math.round(conf*100)+'%</span>';
        });
      } else {
        html += '<span style="color:var(--text-dim);font-size:11px">none</span>';
      }
      html += '</td>';
      html += '<td style="font-family:Space Mono,monospace;color:var(--text-dim);font-size:11px">'+(d.processing_ms||'â€”')+'ms</td>';
      html += '<td><button class="btn btn-ghost btn-sm" style="padding:3px 8px;font-size:11px" '+
        'onclick="vpOpenPreview('+( d.frame_number||0)+',event)">ðŸ”</button></td>';
      html += '</tr>';
    });

    html += '</tbody></table></div>';

    if(r.frames_processed > details.length){
      html += '<div style="margin-top:8px;font-size:11px;color:var(--text-dim);font-family:Space Mono,monospace">Showing first '+details.length+' of '+r.frames_processed+' processed frames</div>';
    }
    html += '</div>';
  } else {
    html += '<div class="empty-state" data-icon="â–¶">No frame details available</div>';
  }

  document.getElementById('video-result').innerHTML = html;
}

// ---- FACES ----
async function registerFace(){
  const code=document.getElementById('face-code').value;const name=document.getElementById('face-name').value;const f=document.getElementById('face-file').files[0];
  if(!code||!name||!f)return toast('Fill all fields','error');
  const fd=new FormData();fd.append('person_code',code);fd.append('person_name',name);fd.append('badge_id',document.getElementById('face-badge').value);fd.append('file',f);
  const r=await(await fetch(API('/faces/register'),{method:'POST',body:fd})).json();
  document.getElementById('face-result').innerHTML='<span class="badge badge-ok">'+name+' registered ('+r.photos+' photos)</span>';
  toast(name+' registered');loadPeople();
}
async function loadPeople(){
  const p=await(await fetch(API('/faces/people'))).json();
  document.getElementById('people-list').innerHTML=p.length?
    '<table><tr><th>Code</th><th>Name</th><th>Badge</th><th>Photos</th></tr>'+
    p.map(x=>'<tr><td>'+x.person_code+'</td><td>'+x.person_name+'</td><td>'+x.badge_id+'</td><td><span class="badge badge-blue">'+x.photos+'</span></td></tr>').join('')+
    '</table>':
    '<div class="empty-state" data-icon="â—‰">No people registered</div>';
}
async function rebuildFaceDB(){const r=await(await fetch(API('/faces/rebuild'),{method:'POST'})).json();toast('Face DB rebuilt: '+r.people_loaded+' people')}

// ---- STREAM ----
async function startStream(){
  const fd=new FormData();fd.append('source',document.getElementById('stream-source').value);fd.append('source_type',document.getElementById('stream-type').value);fd.append('confidence',document.getElementById('stream-conf').value);fd.append('detect_faces',document.getElementById('stream-faces').checked);fd.append('face_threshold',document.getElementById('stream-face-thr').value);
  try{
    const r=await(await fetch(API('/stream/start'),{method:'POST',body:fd})).json();
    currentStreamId=r.session_id;
    document.getElementById('stream-container').innerHTML='<img src="/api/v1/epi/stream/'+currentStreamId+'/feed" style="width:100%">';
    toast('Stream started');streamPoll=setInterval(pollStreamInfo,2000);refreshSessions();
  }catch(e){toast('Stream error','error')}
}
async function stopStream(){
  if(!currentStreamId)return;
  await fetch('/api/v1/epi/stream/'+currentStreamId+'/stop?company_id='+CID,{method:'POST'});
  document.getElementById('stream-container').innerHTML='<div class="stream-placeholder">â—¼ Stopped</div>';
  clearInterval(streamPoll);currentStreamId=null;toast('Stream stopped');refreshSessions();
}
async function pollStreamInfo(){
  if(!currentStreamId)return;
  try{
    const r=await(await fetch('/api/v1/epi/stream/'+currentStreamId+'/status?company_id='+CID)).json();
    let h='<div class="info-row"><span class="info-key">FPS</span><span class="info-val">'+r.fps+'</span></div>';
    h+='<div class="info-row"><span class="info-key">FRAMES</span><span class="info-val">'+r.frame_count+'</span></div>';
    const lr=r.latest_result;
    if(lr){
      h+='<div class="info-row"><span class="info-key">STATUS</span><span class="info-val"><span class="badge '+(lr.compliant?'badge-ok':'badge-err')+'">'+(lr.compliant?'COMPLIANT':'NON-COMPLIANT')+'</span></span></div>';
      if(lr.missing&&lr.missing.length)h+='<div class="info-row"><span class="info-key">MISSING</span><span class="info-val" style="color:var(--danger)">'+lr.missing.join(', ')+'</span></div>';
      if(lr.faces&&lr.faces.length)lr.faces.forEach(f=>{h+='<div class="info-row"><span class="info-key">PERSON</span><span class="info-val">'+f.person_name+' ('+Math.round(f.confidence*100)+'%)</span></div>'});
    }
    document.getElementById('stream-info').innerHTML=h;
  }catch(e){}
}
async function refreshSessions(){
  const ss=await(await fetch(API('/stream/sessions'))).json();
  document.getElementById('stream-sessions').innerHTML=ss.length?
    '<table><tr><th>ID</th><th>Type</th><th>FPS</th><th></th></tr>'+
    ss.map(s=>'<tr><td style="font-family:Space Mono,monospace;font-size:11px">'+s.session_id+'</td><td>'+s.source_type+'</td><td>'+s.fps+'</td><td><button class="btn btn-danger btn-sm" onclick="stopSid(\''+s.session_id+'\')">Stop</button></td></tr>').join('')+
    '</table>':
    '<div class="empty-state" data-icon="â—‰">No active sessions</div>';
}
async function stopSid(sid){
  await fetch('/api/v1/epi/stream/'+sid+'/stop?company_id='+CID,{method:'POST'});
  if(sid===currentStreamId)currentStreamId=null;refreshSessions();toast('Session stopped');
}

document.getElementById('companySelect').value=CID;
loadDashboard();

// ==================== INLINE VIDEO PLAYER ====================
let _vpAnnotations  = [];   // [{frame_number, compliant, missing, detections:[{class_name,confidence,bbox}]}]
let _vpShowLabels   = true;
let _vpShowBoxes    = true;
let _vpRafId        = null;
let _vpLastFrame    = -1;

// Color map per class (matches backend ALL_CLASS_COLORS)
const VP_COLORS = {
  thermal_coat:  '#FF4444',
  thermal_pants: '#4488FF',
  gloves:        '#44FF44',
  helmet:        '#44FFFF',
  boots:         '#FF44FF',
  person:        '#FFA844',
};

function vpPlayerOpen(file, details) {
  if (!file || !details.length) return;

  // store annotations indexed by frame_number
  _vpAnnotations = details;

  const vid = document.getElementById('vp-player-video');
  if (vid._objUrl) URL.revokeObjectURL(vid._objUrl);
  vid._objUrl = URL.createObjectURL(file);
  vid.src = vid._objUrl;

  document.getElementById('vp-player-filename').textContent = 'â–¶ ' + file.name;
  document.getElementById('vp-player-card').style.display = 'block';
  document.getElementById('vp-play-btn').textContent = 'â–¶ Play';
  document.getElementById('vp-live-badge').className = 'vp-status-badge idle';
  document.getElementById('vp-live-badge').textContent = 'â€”';

  vid.onloadedmetadata = () => {
    document.getElementById('vp-seek').max = vid.duration;
    vpUpdateTime();
    vpStartRender();
  };

  // scroll to player
  document.getElementById('vp-player-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function vpPlayerClose() {
  vpStopRender();
  const vid = document.getElementById('vp-player-video');
  vid.pause();
  if (vid._objUrl) { URL.revokeObjectURL(vid._objUrl); vid._objUrl = null; }
  vid.src = '';
  document.getElementById('vp-player-card').style.display = 'none';
  _vpAnnotations = [];
}

function vpTogglePlay() {
  const vid = document.getElementById('vp-player-video');
  if (vid.paused) {
    vid.play();
    document.getElementById('vp-play-btn').textContent = 'â¸ Pause';
  } else {
    vid.pause();
    document.getElementById('vp-play-btn').textContent = 'â–¶ Play';
  }
}

function vpSeek(val) {
  document.getElementById('vp-player-video').currentTime = parseFloat(val);
}

function vpSetSpeed(val) {
  document.getElementById('vp-player-video').playbackRate = parseFloat(val);
}

function vpToggleLabels() {
  _vpShowLabels = !_vpShowLabels;
  const btn = document.getElementById('vp-labels-btn');
  btn.textContent = _vpShowLabels ? 'Labels ON' : 'Labels OFF';
  btn.classList.toggle('active', _vpShowLabels);
}

function vpToggleBoxes() {
  _vpShowBoxes = !_vpShowBoxes;
  const btn = document.getElementById('vp-boxes-btn');
  btn.textContent = _vpShowBoxes ? 'Boxes ON' : 'Boxes OFF';
  btn.classList.toggle('active', _vpShowBoxes);
}

function vpUpdateTime() {
  const vid = document.getElementById('vp-player-video');
  const cur = vid.currentTime || 0;
  const dur = vid.duration   || 0;
  document.getElementById('vp-time').textContent = vpFmtTime(cur) + ' / ' + vpFmtTime(dur);
  document.getElementById('vp-seek').value = cur;
}

function vpFmtTime(s) {
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return m + ':' + String(sec).padStart(2, '0');
}

function vpGetAnnotationForTime(currentTime) {
  if (!_vpAnnotations.length) return null;

  // estimate FPS: use video metadata or default 25
  const vid = document.getElementById('vp-player-video');
  const estimatedFps = _lastVideoFps || 25;

  // find the annotation whose frame_number is closest to currentTime * fps
  const currentFrameEst = currentTime * estimatedFps;

  let best = _vpAnnotations[0];
  let bestDist = Math.abs((best.frame_number || 0) - currentFrameEst);

  for (const ann of _vpAnnotations) {
    const dist = Math.abs((ann.frame_number || 0) - currentFrameEst);
    if (dist < bestDist) {
      bestDist = dist;
      best = ann;
    }
  }
  return best;
}

function vpStartRender() {
  vpStopRender();
  const vid     = document.getElementById('vp-player-video');
  const canvas  = document.getElementById('vp-overlay');
  const wrap    = document.getElementById('vp-player-wrap');

  function render() {
    // sync canvas size to video display size
    const rect = vid.getBoundingClientRect();
    if (canvas.width  !== Math.round(rect.width))  canvas.width  = Math.round(rect.width);
    if (canvas.height !== Math.round(rect.height)) canvas.height = Math.round(rect.height);

    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (!vid.paused || vid.currentTime > 0) {
      vpUpdateTime();
    }

    const ann = vpGetAnnotationForTime(vid.currentTime);

    if (ann) {
      const vw = vid.videoWidth  || canvas.width;
      const vh = vid.videoHeight || canvas.height;
      const scaleX = canvas.width  / vw;
      const scaleY = canvas.height / vh;

      // draw boxes
      if (_vpShowBoxes && ann.detections && ann.detections.length) {
        ann.detections.forEach(det => {
          const b = det.bbox;
          if (!b) return;
          const x = b.x * scaleX;
          const y = b.y * scaleY;
          const w = b.w * scaleX;
          const h = b.h * scaleY;
          const color = VP_COLORS[det.class_name] || '#63B3ED';

          ctx.strokeStyle = color;
          ctx.lineWidth   = 2.5;
          ctx.strokeRect(x, y, w, h);

          // semi-transparent fill
          ctx.fillStyle = color + '22';
          ctx.fillRect(x, y, w, h);

          // label background + text
          if (_vpShowLabels) {
            const label = det.class_name + ' ' + Math.round(det.confidence * 100) + '%';
            ctx.font = 'bold 12px Space Mono, monospace';
            const tw = ctx.measureText(label).width;
            const ty = Math.max(y - 4, 16);

            ctx.fillStyle = color;
            ctx.fillRect(x, ty - 14, tw + 8, 18);

            ctx.fillStyle = '#fff';
            ctx.fillText(label, x + 4, ty);
          }
        });
      }

      // compliance banner
      const bannerH = 36;
      if (ann.compliant) {
        ctx.fillStyle = 'rgba(30,140,69,0.82)';
        ctx.fillRect(0, 0, canvas.width, bannerH);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 14px Space Mono, monospace';
        ctx.fillText('âœ“  COMPLIANT', 10, 24);
      } else {
        ctx.fillStyle = 'rgba(180,20,20,0.82)';
        ctx.fillRect(0, 0, canvas.width, bannerH);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 13px Space Mono, monospace';
        const missing = ann.missing && ann.missing.length ? '  Missing: ' + ann.missing.join(', ') : '';
        ctx.fillText('âœ—  NON-COMPLIANT' + missing, 10, 24);
      }

      // frame number badge (bottom-right)
      ctx.fillStyle = 'rgba(0,0,0,0.55)';
      ctx.fillRect(canvas.width - 100, canvas.height - 24, 96, 22);
      ctx.fillStyle = '#a0aec0';
      ctx.font = '10px Space Mono, monospace';
      ctx.fillText('frame #' + (ann.frame_number || '?'), canvas.width - 96, canvas.height - 8);

      // update live badge
      const badge = document.getElementById('vp-live-badge');
      if (ann.compliant) {
        badge.className = 'vp-status-badge ok';
        badge.textContent = 'âœ“ COMPLIANT';
      } else {
        badge.className = 'vp-status-badge fail';
        badge.textContent = 'âœ— ' + (ann.missing || []).slice(0, 2).join(', ');
      }
    }

    _vpRafId = requestAnimationFrame(render);
  }

  _vpRafId = requestAnimationFrame(render);

  // sync play/pause button
  vid.onplay  = () => document.getElementById('vp-play-btn').textContent = 'â¸ Pause';
  vid.onpause = () => document.getElementById('vp-play-btn').textContent = 'â–¶ Play';
  vid.onended = () => document.getElementById('vp-play-btn').textContent = 'â–¶ Play';
}

function vpStopRender() {
  if (_vpRafId) { cancelAnimationFrame(_vpRafId); _vpRafId = null; }
}
// =============================================================

// ==================== VIDEO FRAME PREVIEW ====================
function vpCloseModal(ev) {
  if (ev && ev.target !== document.getElementById('vp-modal')) return;
  document.getElementById('vp-modal').classList.remove('open');
  // release object URL if any
  const vid = document.getElementById('vp-video');
  if (vid.src && vid.src.startsWith('blob:')) {
    URL.revokeObjectURL(vid.src);
    vid.src = '';
  }
}

async function vpOpenPreview(frameNumber, ev) {
  if (ev) ev.stopPropagation();

  if (!_lastVideoFile) {
    toast('Video file not available. Re-upload the video first.', 'error');
    return;
  }

  // open modal
  document.getElementById('vp-modal').classList.add('open');
  document.getElementById('vp-modal-title').textContent = 'Frame #' + frameNumber + ' â€” ' + _lastVideoFile.name;
  document.getElementById('vp-loading').style.display = 'block';
  document.getElementById('vp-loading').textContent = 'â³ Extracting frame #' + frameNumber + '...';
  document.getElementById('vp-result-img').style.display = 'none';
  document.getElementById('vp-result-row').innerHTML = '';

  try {
    // create object URL for the video
    const vid = document.getElementById('vp-video');
    if (!vid.src || !vid.src.startsWith('blob:')) {
      vid.src = URL.createObjectURL(_lastVideoFile);
    }

    // seek to the frame timestamp
    // skip_frames default is 5, so every processed frame is at multiple of (skip+1)=6
    // frame_number from backend is the actual frame index in the video
    const targetTime = frameNumber / _lastVideoFps;

    await new Promise((resolve, reject) => {
      const timeout = setTimeout(() => reject(new Error('Video seek timeout')), 8000);

      vid.onseeked = () => { clearTimeout(timeout); resolve(); };
      vid.onerror  = () => { clearTimeout(timeout); reject(new Error('Video load error')); };

      if (vid.readyState >= 2) {
        vid.currentTime = targetTime;
      } else {
        vid.onloadeddata = () => { vid.currentTime = targetTime; };
      }
    });

    // capture frame to canvas
    const canvas = document.getElementById('vp-canvas');
    canvas.width  = vid.videoWidth  || 640;
    canvas.height = vid.videoHeight || 480;

    // update estimated FPS from video metadata
    if (vid.duration && vid.duration > 0) {
      // try to get FPS from video (not always available)
      _lastVideoFps = Math.round(frameNumber / targetTime) || 25;
    }

    const ctx = canvas.getContext('2d');
    ctx.drawImage(vid, 0, 0, canvas.width, canvas.height);

    document.getElementById('vp-loading').textContent = 'ðŸ” Running detection...';

    // send to detect/frame endpoint
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.92));
    const conf = document.getElementById('video-conf')?.value || '0.45';
    const faces = document.getElementById('video-faces')?.checked || false;

    const fd = new FormData();
    fd.append('file', blob, 'frame.jpg');
    fd.append('confidence', conf);
    fd.append('detect_faces', faces);
    fd.append('face_threshold', '0.45');
    fd.append('annotate', 'true');

    const resp = await fetch(API('/detect/frame'), { method: 'POST', body: fd });
    if (!resp.ok) throw new Error('Detection failed: ' + resp.statusText);
    const r = await resp.json();

    // show annotated image
    document.getElementById('vp-loading').style.display = 'none';
    const img = document.getElementById('vp-result-img');
    if (r.annotated_base64) {
      img.src = 'data:image/jpeg;base64,' + r.annotated_base64;
      img.style.display = 'block';
    } else {
      // fallback: show raw captured frame
      img.src = canvas.toDataURL('image/jpeg', 0.92);
      img.style.display = 'block';
    }

    // result row
    const compClass = r.compliant ? 'badge-ok' : 'badge-err';
    const compLabel = r.compliant ? 'âœ“ COMPLIANT' : 'âœ— NON-COMPLIANT';
    let rowHtml = '<span class="badge ' + compClass + '">' + compLabel + '</span>';
    rowHtml += '<span style="font-size:12px;color:var(--text-muted)">Detected: <strong>' + (r.detected_count||0) + '/' + (r.required_count||0) + '</strong></span>';

    if (r.missing && r.missing.length) {
      rowHtml += '<span style="font-size:12px;color:var(--danger)">Missing: ' + r.missing.join(', ') + '</span>';
    }
    if (r.detections && r.detections.length) {
      r.detections.forEach(d => {
        rowHtml += '<span class="badge badge-blue" style="font-size:10px">' + d.class_name + ' ' + Math.round(d.confidence*100) + '%</span>';
      });
    }
    rowHtml += '<span style="font-family:Space Mono,monospace;font-size:10px;color:var(--text-dim)">' + (r.processing_ms||'â€”') + 'ms Â· frame#' + frameNumber + '</span>';
    document.getElementById('vp-result-row').innerHTML = rowHtml;

  } catch(e) {
    console.error('vpOpenPreview error:', e);
    document.getElementById('vp-loading').textContent = 'âœ— Error: ' + e.message;
    toast('Frame preview error: ' + e.message, 'error');
  }
}
// =============================================================

// ==================== FILE BROWSER JS ====================
let fbCurrentPath='';
let fbViewMode='list';
let fbAllItems=[];

function fbAPI(ep){return'/api/v1/files'+ep+'?company_id='+CID}

function fbInit(){fbCurrentPath='';fbLoadStats();fbLoadDir('');}

async function fbLoadStats(){
  try{
    const r=await(await fetch(fbAPI('/stats'))).json();
    document.getElementById('fb-stat-size').textContent=r.total_size_fmt;
    document.getElementById('fb-stat-files').textContent=r.file_count;
    document.getElementById('fb-stat-imgs').textContent=r.image_count;
    document.getElementById('fb-stat-models').textContent=r.model_count;
  }catch(e){}
}

async function fbLoadDir(path){
  fbCurrentPath=path;
  const container=document.getElementById('fb-container');
  container.innerHTML='<div class="fb-empty">Carregando...</div>';
  document.getElementById('fb-search').value='';
  try{
    const r=await(await fetch(fbAPI('/list')+'&path='+encodeURIComponent(path))).json();
    fbAllItems=r.items||[];
    fbRenderBreadcrumb(r.breadcrumb||[]);
    fbRender(fbAllItems);
  }catch(e){container.innerHTML='<div class="fb-empty">Erro ao carregar pasta</div>';}
}

function fbRefresh(){fbLoadStats();fbLoadDir(fbCurrentPath);}

function fbFilter(q){
  if(!q){fbRender(fbAllItems);return;}
  const filtered=fbAllItems.filter(i=>i.name.toLowerCase().includes(q.toLowerCase()));
  fbRender(filtered);
}

function fbToggleView(){
  fbViewMode=fbViewMode==='list'?'grid':'list';
  document.getElementById('fb-view-btn').textContent=fbViewMode==='list'?'âŠž Grid':'â˜° Lista';
  fbRender(fbAllItems);
}

function fbRenderBreadcrumb(crumbs){
  const el=document.getElementById('fb-breadcrumb');
  el.innerHTML=crumbs.map((c,i)=>{
    const isLast=i===crumbs.length-1;
    return(i>0?'<span class="fb-sep">/</span>':'')+'<span class="fb-crumb'+(isLast?' active':'')+'" '+(isLast?'':'onclick="fbLoadDir(\''+c.path+'\')"')+'>'+c.label+'</span>';
  }).join('');
}

function fbFileIcon(item){
  if(item.is_dir)return'ðŸ“';if(item.is_image)return'ðŸ–¼';if(item.is_model)return'ðŸ¤–';
  const e=item.ext;
  if(e==='.pt')return'ðŸ¤–';if(e==='.yaml'||e==='.json')return'âš™';
  if(e==='.txt'||e==='.log')return'ðŸ“„';if(e==='.mp4'||e==='.avi')return'ðŸŽ¬';
  if(e==='.csv')return'ðŸ“Š';return'ðŸ“Ž';
}

function fbRender(items){
  const container=document.getElementById('fb-container');
  if(!items.length){container.innerHTML='<div class="fb-empty">Pasta vazia</div>';return;}
  if(fbViewMode==='grid')fbRenderGrid(items,container);
  else fbRenderList(items,container);
}

function fbRenderList(items,container){
  const dlBtn=(item)=>!item.is_dir?'<a class="btn btn-ghost btn-sm" style="padding:3px 8px;font-size:11px;text-decoration:none" href="'+fbAPI('/download')+'&path='+encodeURIComponent(item.path)+'" download="'+item.name+'">â¬‡</a>':'';
  const delBtn=(item)=>'<button class="btn btn-danger btn-sm" style="padding:3px 8px;font-size:11px" onclick="fbConfirmDelete(event,\''+item.path+'\',\''+item.name+'\')">âœ•</button>';
  container.innerHTML=
    '<div class="fb-thead"><span></span><span>Nome</span><span style="text-align:right">Tamanho</span><span>Modificado</span><span></span></div>'+
    '<div class="fb-list">'+
    items.map(item=>
      '<div class="fb-row'+(item.is_dir?' fb-dir':'')+'" onclick="fbClickItem(event,\''+item.path+'\','+item.is_dir+','+item.is_image+')">'+
      '<span class="fb-icon">'+fbFileIcon(item)+'</span>'+
      '<span class="fb-name" title="'+item.name+'">'+item.name+'</span>'+
      '<span class="fb-size">'+(item.is_dir?'â€”':item.size_fmt)+'</span>'+
      '<span class="fb-date">'+item.modified+'</span>'+
      '<span class="fb-actions" onclick="event.stopPropagation()">'+dlBtn(item)+delBtn(item)+'</span>'+
      '</div>'
    ).join('')+
    '</div>';
}

function fbRenderGrid(items,container){
  container.innerHTML=
    '<div class="fb-grid">'+
    items.map(item=>{
      const thumbSrc=item.is_image?fbAPI('/thumb')+'&path='+encodeURIComponent(item.path):null;
      const thumbHTML=thumbSrc
        ?'<div class="fb-card-thumb"><img src="'+thumbSrc+'" loading="lazy" onerror="this.parentElement.innerHTML=\'ðŸ–¼\'"></div>'
        :'<div class="fb-card-thumb" style="font-size:36px;display:flex;align-items:center;justify-content:center">'+fbFileIcon(item)+'</div>';
      return'<div class="fb-card" onclick="fbClickItem(event,\''+item.path+'\','+item.is_dir+','+item.is_image+')">'+
        thumbHTML+
        '<div class="fb-card-info"><div class="fb-card-name" title="'+item.name+'">'+item.name+'</div><div class="fb-card-size">'+(item.is_dir?'Pasta':item.size_fmt)+'</div></div>'+
        '<div class="fb-card-actions" onclick="event.stopPropagation()">'+
        (!item.is_dir?'<a class="fb-action-btn" href="'+fbAPI('/download')+'&path='+encodeURIComponent(item.path)+'" download="'+item.name+'" onclick="event.stopPropagation()" title="Download">â¬‡</a>':'')+
        '<button class="fb-action-btn del" onclick="fbConfirmDelete(event,\''+item.path+'\',\''+item.name+'\')">âœ•</button>'+
        '</div>'+
        '</div>';
    }).join('')+
    '</div>';
}

function fbClickItem(ev,path,isDir,isImage){
  if(isDir)fbLoadDir(path);
  else if(isImage)fbOpenLightbox(path);
  else window.location.href=fbAPI('/download')+'&path='+encodeURIComponent(path);
}

function fbOpenLightbox(path){
  const lb=document.getElementById('fb-lightbox');
  const img=document.getElementById('fb-lightbox-img');
  const name=document.getElementById('fb-lightbox-name');
  const dl=document.getElementById('fb-lightbox-dl');
  const src=fbAPI('/download')+'&path='+encodeURIComponent(path)+'&inline=true';
  img.src=src;name.textContent=path.split('/').pop();
  dl.href=fbAPI('/download')+'&path='+encodeURIComponent(path);
  dl.download=path.split('/').pop();
  lb.style.display='flex';document.body.style.overflow='hidden';
}

function fbCloseLightbox(){
  document.getElementById('fb-lightbox').style.display='none';
  document.getElementById('fb-lightbox-img').src='';
  document.body.style.overflow='';
}

document.addEventListener('keydown',e=>{if(e.key==='Escape')fbCloseLightbox();});

async function fbConfirmDelete(ev,path,name){
  ev.stopPropagation();
  if(!confirm('Deletar "'+name+'"?\nEssa aÃ§Ã£o nÃ£o pode ser desfeita.'))return;
  try{
    const r=await(await fetch(fbAPI('/delete')+'&path='+encodeURIComponent(path),{method:'DELETE'})).json();
    if(r.deleted){toast('Deletado: '+name);fbRefresh();}
  }catch(e){toast('Erro ao deletar','error');}
}

// ==================== FILE BROWSER: UPLOAD + MKDIR ====================
let fbUploadFiles=[];
let fbUploadIdCounter=0;

function fbShowUploadModal(){
  const dest=document.getElementById('fb-upload-dest');
  dest.value=fbCurrentPath?'Company '+CID+' / '+fbCurrentPath.replace(/\//g,' / '):'Company '+CID+' (raiz)';
  document.getElementById('fb-upload-msg').innerHTML='';
  document.getElementById('fb-upload-progress').style.display='none';
  const btn=document.getElementById('fb-upload-btn');
  btn.disabled=false;btn.textContent='â¬† Enviar Arquivos';
  fbRenderQueue();
  document.getElementById('fb-upload-modal').classList.add('open');
}

function fbHideUploadModal(ev){
  if(ev&&ev.target!==document.getElementById('fb-upload-modal'))return;
  document.getElementById('fb-upload-modal').classList.remove('open');
}

function fbDragOver(ev){ev.preventDefault();document.getElementById('fb-dropzone').classList.add('drag-over');}
function fbDragLeave(){document.getElementById('fb-dropzone').classList.remove('drag-over');}
function fbDrop(ev){ev.preventDefault();document.getElementById('fb-dropzone').classList.remove('drag-over');fbAddFiles(ev.dataTransfer.files);}

function fbAddFiles(fileList){for(const f of fileList)fbUploadFiles.push({file:f,id:++fbUploadIdCounter});fbRenderQueue();}
function fbRemoveFromQueue(id){fbUploadFiles=fbUploadFiles.filter(x=>x.id!==id);fbRenderQueue();}
function fbClearQueue(){fbUploadFiles=[];fbRenderQueue();document.getElementById('fb-upload-msg').innerHTML='';}

function fbRenderQueue(){
  const q=document.getElementById('fb-queue');
  if(!fbUploadFiles.length){q.innerHTML='';return;}
  q.innerHTML=fbUploadFiles.map(function({file:f,id}){
    const icon=f.type.startsWith('image/')?'ðŸ–¼':f.name.endsWith('.pt')?'ðŸ¤–':'ðŸ“Ž';
    return'<div class="fb-queue-item"><span class="fq-icon">'+icon+'</span><span class="fq-name" title="'+f.name+'">'+f.name+'</span><span class="fq-size">'+fbFmtSize(f.size)+'</span><button class="fq-rm" onclick="fbRemoveFromQueue('+id+')">âœ•</button></div>';
  }).join('');
}

function fbFmtSize(b){const units=['B','KB','MB','GB'];let i=0;while(b>=1024&&i<units.length-1){b/=1024;i++;}return b.toFixed(1)+' '+units[i];}

async function fbDoUpload(){
  if(!fbUploadFiles.length){toast('Selecione arquivos primeiro','error');return;}
  const btn=document.getElementById('fb-upload-btn');
  const msg=document.getElementById('fb-upload-msg');
  const prog=document.getElementById('fb-upload-progress');
  const fill=document.getElementById('fb-prog-fill');
  const pctEl=document.getElementById('fb-prog-pct');
  const lblEl=document.getElementById('fb-prog-label');
  btn.disabled=true;btn.textContent='Enviando...';
  prog.style.display='block';fill.style.width='5%';pctEl.textContent='0%';msg.innerHTML='';
  const fd=new FormData();
  fbUploadFiles.forEach(({file})=>fd.append('files',file));
  try{
    await new Promise((resolve,reject)=>{
      const xhr=new XMLHttpRequest();
      xhr.open('POST','/api/v1/files/upload?company_id='+CID+'&path='+encodeURIComponent(fbCurrentPath));
      xhr.upload.onprogress=(e)=>{if(e.lengthComputable){const pct=Math.round((e.loaded/e.total)*100);fill.style.width=pct+'%';pctEl.textContent=pct+'%';lblEl.textContent='Enviando '+fbFmtSize(e.loaded)+' / '+fbFmtSize(e.total);}};
      xhr.onload=()=>{
        if(xhr.status>=200&&xhr.status<300){
          const r=JSON.parse(xhr.responseText);const ok=r.uploaded||0;const err=r.errors||0;
          fill.style.width='100%';pctEl.textContent='100%';
          msg.innerHTML='<span class="badge badge-ok">'+ok+' arquivo(s) enviado(s)</span>'+(err?' <span class="badge badge-err">'+err+' erro(s)</span>':'');
          toast('âœ“ '+ok+' arquivo(s) enviado(s)');
          fbUploadFiles=[];fbRenderQueue();btn.disabled=false;btn.textContent='â¬† Enviar Arquivos';
          setTimeout(()=>fbRefresh(),800);resolve();
        }else reject(new Error(xhr.responseText||'Upload falhou'));
      };
      xhr.onerror=()=>reject(new Error('Erro de rede'));
      xhr.send(fd);
    });
  }catch(e){msg.innerHTML='<span class="badge badge-err">'+e.message+'</span>';toast('Erro no upload','error');btn.disabled=false;btn.textContent='â¬† Enviar Arquivos';}
}

function fbShowMkdirModal(){
  document.getElementById('fb-mkdir-name').value='';document.getElementById('fb-mkdir-msg').innerHTML='';
  const pathLabel=fbCurrentPath?'Company '+CID+' / '+fbCurrentPath.replace(/\//g,' / ')+' / <nova pasta>':'Company '+CID+' / <nova pasta>';
  document.getElementById('fb-mkdir-path').textContent='ðŸ“ '+pathLabel;
  document.getElementById('fb-mkdir-modal').classList.add('open');
  setTimeout(()=>document.getElementById('fb-mkdir-name').focus(),80);
}

function fbHideMkdirModal(ev){
  if(ev&&ev.target!==document.getElementById('fb-mkdir-modal'))return;
  document.getElementById('fb-mkdir-modal').classList.remove('open');
}

async function fbDoMkdir(){
  const name=document.getElementById('fb-mkdir-name').value.trim();
  const msg=document.getElementById('fb-mkdir-msg');
  if(!name){msg.innerHTML='<span class="badge badge-err">Informe um nome</span>';return;}
  if(/[\\/:*?"<>|]/.test(name)){msg.innerHTML='<span class="badge badge-err">Nome invÃ¡lido</span>';return;}
  const fullPath=fbCurrentPath?fbCurrentPath+'/'+name:name;
  try{
    const resp=await fetch('/api/v1/files/mkdir?company_id='+CID+'&path='+encodeURIComponent(fullPath),{method:'POST'});
    const r=await resp.json();
    if(!resp.ok){msg.innerHTML='<span class="badge badge-err">'+(r.detail||'Erro')+'</span>';return;}
    toast('ðŸ“ Pasta "'+name+'" criada');document.getElementById('fb-mkdir-modal').classList.remove('open');fbRefresh();
  }catch(e){msg.innerHTML='<span class="badge badge-err">'+e.message+'</span>';}
}

// ===================== BROWSER CAMERA JS =====================
let _camStream=null;
let _camTimer=null;
let _camMirror=true;
let _camSending=false;
let _camFrameCount=0;
let _camFpsTs=performance.now();
let _camFps=0;

// async function camStart(){
//   try{
//     // const constraints={video:{width:{ideal:1280},height:{ideal:720},facingMode:'environment'},audio:false};
//     let stream;
//     try{stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});}
//     catch(_){stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});}
//     _camStream=stream;
//     await camPopulateDevices();
//     const video=document.getElementById('cam-video');
//     video.srcObject=stream;video.style.display='block';
//     document.getElementById('cam-placeholder').style.display='none';
//     document.getElementById('cam-result-img').style.display='none';
//     document.getElementById('cam-status-bar').style.display='flex';
//     document.getElementById('cam-start-btn').style.display='none';
//     document.getElementById('cam-stop-btn').style.display='inline-flex';
//     document.getElementById('cam-badge').className='badge badge-warn';
//     document.getElementById('cam-badge').textContent='ATIVO';
//     document.getElementById('cam-mirror-btn').classList.add('visible');
//     camApplyMirror();
//     document.getElementById('cam-container').classList.add('cam-scanning');
//     const interval=parseInt(document.getElementById('cam-interval').value);
//     _camTimer=setInterval(camSendFrame,interval);
//     toast('ðŸ“· CÃ¢mera iniciada');
//   }catch(e){
//     if(e.name==='NotAllowedError')toast('PermissÃ£o de cÃ¢mera negada. Verifique as configuraÃ§Ãµes do browser.','error');
//     else if(e.name==='NotFoundError')toast('Nenhuma cÃ¢mera encontrada neste dispositivo.','error');
//     else toast('Erro ao acessar cÃ¢mera: '+e.message,'error');
//     console.error('Camera error:',e);
//   }
// }

async function camStart(){
  console.log("Tentando iniciar a cÃ¢mera...");
  
  try {
    // PRIMEIRO: Verificar se existem cÃ¢meras disponÃ­veis
    console.log("Verificando dispositivos de vÃ­deo disponÃ­veis...");
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(device => device.kind === 'videoinput');
    
    console.log("Dispositivos de vÃ­deo encontrados:", videoDevices.length);
    
    if (videoDevices.length === 0) {
      console.warn("Nenhum dispositivo de cÃ¢mera encontrado!");
      toast('âŒ Nenhuma cÃ¢mera encontrada neste computador.', 'error');
      
      // Atualiza a UI para mostrar mensagem amigÃ¡vel
      document.getElementById('cam-placeholder').innerHTML = 
        '<div style="text-align:center; padding:20px">' +
        'ðŸ“· <strong>Nenhuma cÃ¢mera detectada</strong><br>' +
        '<span style="font-size:12px; color:#666; margin-top:10px; display:block">' +
        'Este computador nÃ£o possui cÃ¢mera ou ela estÃ¡ desabilitada.</span>' +
        '</div>';
      return;
    }
    
    console.log("CÃ¢meras disponÃ­veis:", videoDevices.map(d => d.label || 'Sem nome'));
    
    // Tenta acessar qualquer cÃ¢mera com configuraÃ§Ãµes padrÃ£o
    const constraints = {
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        deviceId: videoDevices[0].deviceId ? { exact: videoDevices[0].deviceId } : undefined
      },
      audio: false
    };

    console.log("Solicitando permissÃ£o com constraints:", constraints);
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    console.log("PermissÃ£o concedida. Stream obtida:", stream);

    _camStream = stream;
    await camPopulateDevices();

    const video = document.getElementById('cam-video');
    video.srcObject = stream;
    video.style.display = 'block';

    // Toca o vÃ­deo quando os metadados estiverem carregados
    video.onloadedmetadata = () => {
      console.log("Metadados carregados, tentando dar play...");
      video.play().catch(err => {
        console.error("Erro no play apÃ³s loadedmetadata:", err);
        toast('Erro ao iniciar o vÃ­deo.', 'error');
        camStop();
      });
    };

    // Se os metadados jÃ¡ estiverem carregados
    if (video.readyState >= 1) {
      video.onloadedmetadata = null;
      video.play().catch(err => {
        console.error("Erro no play imediato:", err);
        toast('Erro ao iniciar o vÃ­deo.', 'error');
        camStop();
      });
    }

    // Atualiza a interface
    document.getElementById('cam-placeholder').style.display = 'none';
    document.getElementById('cam-result-img').style.display = 'none';
    document.getElementById('cam-status-bar').style.display = 'flex';
    document.getElementById('cam-start-btn').style.display = 'none';
    document.getElementById('cam-stop-btn').style.display = 'inline-flex';
    document.getElementById('cam-badge').className = 'badge badge-warn';
    document.getElementById('cam-badge').textContent = 'ATIVO';
    document.getElementById('cam-mirror-btn').classList.add('visible');

    camApplyMirror();
    document.getElementById('cam-container').classList.add('cam-scanning');

    const interval = parseInt(document.getElementById('cam-interval').value);
    if(_camTimer) clearInterval(_camTimer);
    _camTimer = setInterval(camSendFrame, interval);
    toast('ðŸ“· CÃ¢mera iniciada');

  } catch(e) {
    console.error("Erro detalhado ao acessar a cÃ¢mera:", e);

    // Tratamento especÃ­fico para erros do Cloudflare/Chrome
    if (error.name === 'NotAllowedError') {
      if (error.message.includes('Permissions-Policy')) {
        toast('O Cloudflare ou o Chrome estÃ¡ bloqueando o acesso Ã  cÃ¢mera. Atualize a pÃ¡gina e tente novamente.', 'error');
      } else {
        toast('PermissÃ£o de cÃ¢mera negada. Clique no Ã­cone da cÃ¢mera na barra de endereÃ§os e permita o acesso.', 'error');
      }
    } else if (error.name === 'NotFoundError') {
      toast('Nenhuma cÃ¢mera encontrada. Verifique se o Cloudflare nÃ£o estÃ¡ bloqueando o dispositivo.', 'error');
    } else if (error.name === 'NotReadableError') {
      toast('CÃ¢mera estÃ¡ sendo usada por outro aplicativo ou bloqueada pelo Cloudflare.', 'error');
    } else {
      toast('Erro ao acessar cÃ¢mera: ' + (error.message || 'Erro desconhecido'), 'error');
    }
    
    // Tratamento especÃ­fico para "Failed to allocate videosource"
    if (e.message && e.message.includes('Failed to allocate videosource')) {
      toast('âŒ Nenhuma cÃ¢mera disponÃ­vel neste computador.', 'error');
      document.getElementById('cam-placeholder').innerHTML = 
        '<div style="text-align:center; padding:20px">' +
        'ðŸ“· <strong>CÃ¢mera nÃ£o encontrada</strong><br>' +
        '<span style="font-size:12px; color:#666; margin-top:10px; display:block">' +
        'Este computador nÃ£o possui cÃ¢mera ou o driver nÃ£o estÃ¡ instalado.</span>' +
        '</div>';
    }
    else if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
      toast('âŒ PermissÃ£o de cÃ¢mera negada.', 'error');
    } else if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError') {
      toast('âŒ Nenhuma cÃ¢mera encontrada.', 'error');
    } else if (e.name === 'NotReadableError' || e.name === 'TrackStartError') {
      toast('âŒ CÃ¢mera estÃ¡ sendo usada por outro aplicativo.', 'error');
    } else {
      toast('âŒ Erro ao acessar cÃ¢mera: ' + (e.message || 'Erro desconhecido'), 'error');
    }
    
    camStop();
  }
}

function camStop(){
  if(_camTimer){clearInterval(_camTimer);_camTimer=null;}
  if(_camStream){_camStream.getTracks().forEach(t=>t.stop());_camStream=null;}
  const video=document.getElementById('cam-video');
  video.srcObject=null;video.style.display='none';
  document.getElementById('cam-placeholder').style.display='flex';
  document.getElementById('cam-result-img').style.display='none';
  document.getElementById('cam-status-bar').style.display='none';
  document.getElementById('cam-start-btn').style.display='inline-flex';
  document.getElementById('cam-stop-btn').style.display='none';
  document.getElementById('cam-badge').className='badge badge-off';
  document.getElementById('cam-badge').textContent='INATIVO';
  document.getElementById('cam-mirror-btn').classList.remove('visible');
  document.getElementById('cam-device-sel').classList.remove('visible');
  document.getElementById('cam-container').classList.remove('cam-scanning');
  document.getElementById('cam-result-detail').innerHTML='<div class="empty-state" data-icon="ðŸ“·">CÃ¢mera parada</div>';
  _camFrameCount=0;_camFps=0;
  toast('CÃ¢mera parada');
}

async function camSendFrame(){
  if(_camSending)return;
  const video=document.getElementById('cam-video');
  if(!video.videoWidth)return;
  _camSending=true;
  const t0=performance.now();
  try{
    const canvas=document.getElementById('cam-canvas');
    canvas.width=video.videoWidth;canvas.height=video.videoHeight;
    const ctx=canvas.getContext('2d');
    if(_camMirror){ctx.save();ctx.scale(-1,1);ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);ctx.restore();}
    else ctx.drawImage(video,0,0);
    const blob=await new Promise(resolve=>canvas.toBlob(resolve,'image/jpeg',0.8));
    const fd=new FormData();
    fd.append('file',blob,'frame.jpg');
    fd.append('confidence',document.getElementById('cam-conf').value);
    fd.append('detect_faces',document.getElementById('cam-faces').checked);
    fd.append('face_threshold','0.45');
    fd.append('annotate','true');
    const resp=await fetch(API('/detect/frame'),{method:'POST',body:fd});
    if(!resp.ok){_camSending=false;return;}
    const r=await resp.json();
    const elapsed=Math.round(performance.now()-t0);
    if(r.annotated_base64){
      const img=document.getElementById('cam-result-img');
      const v2=document.getElementById('cam-video');
      img.src='data:image/jpeg;base64,'+r.annotated_base64;
      img.style.transform=_camMirror?'scaleX(-1)':'';
      img.style.display='block';v2.style.display='none';
    }
    _camFrameCount++;
    const now=performance.now();const elapsed2=(now-_camFpsTs)/1000;
    if(elapsed2>=1.0){_camFps=Math.round(_camFrameCount/elapsed2);_camFrameCount=0;_camFpsTs=now;}
    document.getElementById('cam-fps-badge').textContent=_camFps+' FPS';
    const cbadge=document.getElementById('cam-compliance-badge');
    if(r.compliant){cbadge.textContent='âœ“ COMPLIANT';cbadge.className='cam-fps-badge compliant';}
    else{cbadge.textContent='âœ— '+(r.missing||[]).join(', ')||'NON-COMPLIANT';cbadge.className='cam-fps-badge noncompliant';}
    document.getElementById('cam-ms-badge').textContent=elapsed+'ms';
    camRenderResult(r,elapsed);
  }catch(e){console.warn('Frame send error:',e);}
  finally{_camSending=false;}
}

function camRenderResult(r,ms){
  const el=document.getElementById('cam-result-detail');
  const compClass=r.compliant?'result-compliant':'result-noncompliant';
  const compLabel=r.compliant?'âœ“ COMPLIANT':'âœ— NON-COMPLIANT';
  const compColor=r.compliant?'ok':'fail';
  let html='<div class="result-box '+compClass+'">';
  html+='<div class="result-title '+compColor+'">'+compLabel+'</div>';
  html+='<div style="font-size:12px;color:var(--text-muted);margin-top:4px">EPIs detectados: <strong>'+(r.detected_count||0)+'/'+(r.required_count||0)+'</strong></div>';
  if(r.missing&&r.missing.length)html+='<div style="margin-top:8px;font-size:12px">Faltando: <span style="color:var(--danger)">'+r.missing.join(', ')+'</span></div>';
  if(r.detections&&r.detections.length){
    html+='<div style="margin-top:8px">';
    r.detections.forEach(d=>{html+='<span class="badge badge-blue" style="margin:2px;font-size:10px">'+d.class_name+' '+Math.round(d.confidence*100)+'%</span>';});
    html+='</div>';
  }
  if(r.faces&&r.faces.length){
    html+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(0,0,0,0.08)">';
    r.faces.forEach(f=>{
      const fc=f.recognized?'badge-ok':'badge-off';
      html+='<div style="font-size:12px;margin-bottom:4px"><span class="badge '+fc+'">'+f.person_name+'</span>';
      if(f.recognized)html+=' <span style="color:var(--text-muted);font-size:11px">'+Math.round(f.confidence*100)+'% match</span>';
      html+='</div>';
    });
    html+='</div>';
  }
  html+='<div style="margin-top:8px;font-size:10px;color:var(--text-dim);font-family:Space Mono,monospace">â± '+ms+'ms Â· model: '+(r.model_name||'best')+'</div>';
  html+='</div>';
  el.innerHTML=html;
}

function camToggleMirror(){_camMirror=document.getElementById('cam-mirror').checked;camApplyMirror();}
function camApplyMirror(){document.getElementById('cam-video').style.transform=_camMirror?'scaleX(-1)':'';}

async function camPopulateDevices(){
  try{
    const devices=await navigator.mediaDevices.enumerateDevices();
    const cams=devices.filter(d=>d.kind==='videoinput');
    const sel=document.getElementById('cam-device-sel');
    sel.innerHTML=cams.map((d,i)=>'<option value="'+d.deviceId+'">'+(d.label||'CÃ¢mera '+(i+1))+'</option>').join('');
    if(cams.length>1)sel.classList.add('visible');
  }catch(e){}
}

async function camSwitchDevice(){
  if(!_camStream)return;
  const deviceId=document.getElementById('cam-device-sel').value;
  if(!deviceId)return;
  _camStream.getTracks().forEach(t=>t.stop());
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:deviceId},width:{ideal:1280},height:{ideal:720}},audio:false});
    _camStream=stream;document.getElementById('cam-video').srcObject=stream;toast('CÃ¢mera alterada');
  }catch(e){toast('Erro ao trocar cÃ¢mera: '+e.message,'error');}
}


// function vpDownload() {
//   const vid = document.getElementById('vp-player-video');
//   if (!vid.src || !_lastVideoFile) {
//     toast('Nenhum vÃ­deo carregado para download.', 'error');
//     return;
//   }
//   const a = document.createElement('a');
//   a.href = vid.src; // jÃ¡ Ã© um blob URL
//   a.download = _lastVideoFile ? _lastVideoFile.name : 'video.mp4';
//   document.body.appendChild(a);
//   a.click();
//   document.body.removeChild(a);
//   toast('â¬‡ Download iniciado: ' + a.download);
// }

async function vpDownload() {
  if (!_lastVideoFile || !_vpAnnotations.length) {
    toast('Nenhum vÃ­deo ou anotaÃ§Ãµes carregadas.', 'error');
    return;
  }

  const vid = document.getElementById('vp-player-video');
  const overlayCanvas = document.getElementById('vp-overlay');

  // Cria um canvas combinado (vÃ­deo + overlay)
  const mergeCanvas = document.createElement('canvas');
  mergeCanvas.width  = vid.videoWidth  || 1280;
  mergeCanvas.height = vid.videoHeight || 720;
  const mCtx = mergeCanvas.getContext('2d');

  // Verifica suporte a MediaRecorder
  const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9')
    ? 'video/webm;codecs=vp9'
    : MediaRecorder.isTypeSupported('video/webm')
    ? 'video/webm'
    : null;

  if (!mimeType) {
    toast('Seu browser nÃ£o suporta gravaÃ§Ã£o de vÃ­deo.', 'error');
    return;
  }

  toast('ðŸŽ¬ Iniciando exportaÃ§Ã£o do vÃ­deo anotado...');

  const btn = document.getElementById('vp-download-btn');
  btn.disabled = true;
  btn.textContent = 'â³ Exportando...';

  const chunks = [];
  const stream = mergeCanvas.captureStream(30);
  const recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 5_000_000 });

  recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };

  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: mimeType });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    const ext  = mimeType.includes('mp4') ? 'mp4' : 'webm';
    a.href     = url;
    a.download = (_lastVideoFile.name.replace(/\.[^.]+$/, '') || 'video') + '_annotated.' + ext;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    btn.disabled = false;
    btn.textContent = 'â¬‡ Download';
    toast('âœ… Download concluÃ­do!');
  };

  // FunÃ§Ã£o que renderiza um frame combinado
  function renderMergeFrame() {
    mCtx.clearRect(0, 0, mergeCanvas.width, mergeCanvas.height);
    mCtx.drawImage(vid, 0, 0, mergeCanvas.width, mergeCanvas.height);

    // Pega anotaÃ§Ã£o mais prÃ³xima do tempo atual
    const ann = vpGetAnnotationForTime(vid.currentTime);
    if (!ann) return;

    const vw = vid.videoWidth  || mergeCanvas.width;
    const vh = vid.videoHeight || mergeCanvas.height;
    const sx = mergeCanvas.width  / vw;
    const sy = mergeCanvas.height / vh;

    // Desenha boxes
    if (_vpShowBoxes && ann.detections && ann.detections.length) {
      ann.detections.forEach(det => {
        const b = det.bbox; if (!b) return;
        const x = b.x * sx, y = b.y * sy, w = b.w * sx, h = b.h * sy;
        const color = VP_COLORS[det.class_name] || '#63B3ED';
        mCtx.strokeStyle = color; mCtx.lineWidth = 2.5;
        mCtx.strokeRect(x, y, w, h);
        mCtx.fillStyle = color + '22'; mCtx.fillRect(x, y, w, h);
        if (_vpShowLabels) {
          const label = det.class_name + ' ' + Math.round(det.confidence * 100) + '%';
          mCtx.font = 'bold 12px Space Mono, monospace';
          const tw = mCtx.measureText(label).width;
          const ty = Math.max(y - 4, 16);
          mCtx.fillStyle = color; mCtx.fillRect(x, ty - 14, tw + 8, 18);
          mCtx.fillStyle = '#fff'; mCtx.fillText(label, x + 4, ty);
        }
      });
    }

    // Banner compliance
    const bannerH = 36;
    if (ann.compliant) {
      mCtx.fillStyle = 'rgba(30,140,69,0.82)'; mCtx.fillRect(0, 0, mergeCanvas.width, bannerH);
      mCtx.fillStyle = '#fff'; mCtx.font = 'bold 14px Space Mono, monospace';
      mCtx.fillText('âœ“  COMPLIANT', 10, 24);
    } else {
      mCtx.fillStyle = 'rgba(180,20,20,0.82)'; mCtx.fillRect(0, 0, mergeCanvas.width, bannerH);
      mCtx.fillStyle = '#fff'; mCtx.font = 'bold 13px Space Mono, monospace';
      const miss = ann.missing && ann.missing.length ? '  Missing: ' + ann.missing.join(', ') : '';
      mCtx.fillText('âœ—  NON-COMPLIANT' + miss, 10, 24);
    }

    // Badge frame
    mCtx.fillStyle = 'rgba(0,0,0,0.55)';
    mCtx.fillRect(mergeCanvas.width - 100, mergeCanvas.height - 24, 96, 22);
    mCtx.fillStyle = '#a0aec0'; mCtx.font = '10px Space Mono, monospace';
    mCtx.fillText('frame #' + (ann.frame_number || '?'), mergeCanvas.width - 96, mergeCanvas.height - 8);
  }

  // Inicia gravaÃ§Ã£o e toca o vÃ­deo do inÃ­cio
  recorder.start(100); // coleta dados a cada 100ms
  vid.currentTime = 0;
  await new Promise(r => setTimeout(r, 300)); // aguarda seek
  vid.playbackRate = 1;
  vid.play();

  // Loop de renderizaÃ§Ã£o sincronizado com o vÃ­deo
  let rafLoop;
  function loop() {
    renderMergeFrame();
    if (!vid.ended && !vid.paused) {
      rafLoop = requestAnimationFrame(loop);
    } else {
      // VÃ­deo terminou
      cancelAnimationFrame(rafLoop);
      recorder.stop();
      vid.pause();
      document.getElementById('vp-play-btn').textContent = 'â–¶ Play';
    }
  }

  vid.onended = () => {
    cancelAnimationFrame(rafLoop);
    recorder.stop();
    document.getElementById('vp-play-btn').textContent = 'â–¶ Play';
  };

  rafLoop = requestAnimationFrame(loop);
}

</script>

<!-- ===== VIDEO FRAME PREVIEW MODAL ===== -->
<div class="vp-modal-backdrop" id="vp-modal" onclick="vpCloseModal(event)">
  <div class="vp-modal" onclick="event.stopPropagation()">
    <button class="vp-modal-close" onclick="vpCloseModal()">âœ•</button>
    <div class="vp-modal-title">
      <span>â–¶</span>
      <span id="vp-modal-title">Frame Preview</span>
    </div>
    <div class="vp-img-wrap" id="vp-img-wrap">
      <div class="vp-loading" id="vp-loading">â³ Extracting frame...</div>
      <img id="vp-result-img" src="" alt="frame" style="display:none">
    </div>
    <div class="vp-result-row" id="vp-result-row"></div>
    <!-- hidden elements for frame extraction -->
    <video id="vp-video" style="display:none" muted preload="auto"></video>
    <canvas id="vp-canvas" style="display:none"></canvas>
  </div>
</div>
<!-- ===== FIM VIDEO FRAME PREVIEW MODAL ===== -->

</body>
</html>